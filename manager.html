<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>PM Hub Manager</title>
    <link rel="stylesheet" href="pm-hub-styles.css">

    <!-- QR Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>

    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, getDocs, updateDoc, deleteDoc, arrayUnion, serverTimestamp, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Initialize Firebase (MUST match hub's config exactly)
        const firebaseConfig = {
            apiKey: "AIzaSyDnwDzHtjFKaWY-VwIMJtomfunkp7t9GFc",
            authDomain: "assettracker1-5b976.firebaseapp.com",
            projectId: "assettracker1-5b976",
            storageBucket: "assettracker1-5b976.firebasestorage.app",
            messagingSenderId: "260186083597",
            appId: "1:260186083597:web:5ec0eb9d5f8a4132022044"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            window.firebaseEnabled = true;
            window.db = db;
            window.firestore = { collection, doc, setDoc, getDoc, onSnapshot, getDocs, updateDoc, deleteDoc, arrayUnion, serverTimestamp, query, where, orderBy };
            console.log('‚úì Manager: Firebase initialized');
        } catch (error) {
            console.error('Manager: Firebase init error:', error);
            window.firebaseEnabled = false;
        }
    </script>

    <!-- PM Hub Chat Library -->
    <script src="pm-hub-chat.js"></script>

    <!-- PM Hub Emoji Picker -->
    <script src="pm-hub-emoji.js"></script>

    <!-- PM Hub Firebase Operations -->
    <script src="pm-hub-firebase.js"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-dark);
            overflow-x: hidden;
            font-family: system-ui, -apple-system, sans-serif;
            color: var(--text-primary);
        }

        /* Header with Management Toggle */
        .manager-header {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .manager-name {
            font-size: 18px;
            font-weight: 600;
        }

        .mode-toggle {
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--accent-primary);
            color: white;
        }

        /* Sync Status Indicators */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }

        .status-dot.synced {
            background: var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-danger);
            border-radius: 8px;
            color: var(--accent-danger);
            font-size: 14px;
            cursor: pointer;
        }

        /* Clock Out Button - Always visible when clocked in */
        .clock-out-fixed {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--accent-danger), #dc2626);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
            cursor: pointer;
            display: none;
        }

        .clock-out-fixed:active {
            transform: scale(0.95);
        }

        /* Container */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Big Action Buttons */
        .big-btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .big-btn:active {
            transform: scale(0.98);
        }

        .big-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .big-btn.success {
            background: linear-gradient(135deg, var(--accent-success), #059669);
            color: white;
        }

        .big-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), #2563eb);
            color: white;
        }

        .big-btn.danger {
            background: linear-gradient(135deg, var(--accent-danger), #dc2626);
            color: white;
        }

        .big-btn.warning {
            background: linear-gradient(135deg, var(--accent-warning), #d97706);
            color: white;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        select, input, textarea {
            width: 100%;
            padding: 14px;
            background: rgba(21, 25, 50, 0.9);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
        }

        select option {
            background: #1a1f3a;
            color: #ffffff;
            padding: 12px;
        }

        /* Status Card */
        .status-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .status-card.clocked-in {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
        }

        .section-header {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 24px 0 12px 0;
            letter-spacing: 0.5px;
        }

        .hidden {
            display: none;
        }

        /* Management Cards */
        .management-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .management-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .management-card:active {
            transform: scale(0.95);
        }

        .management-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .management-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--text-primary);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .management-title {
            font-size: 14px;
            font-weight: 600;
        }

        /* List Items */
        .list-item {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-edit {
            background: var(--accent-primary);
            color: white;
        }

        .btn-delete {
            background: var(--accent-danger);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            max-width: 500px;
            margin: 20px auto;
            background: var(--bg-dark);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--glass-border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--accent-success);
            background: rgba(16, 185, 129, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Notification Bell & Badge */
        .notification-bell {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-danger);
            color: white;
            font-size: 10px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            animation: badge-pulse 2s infinite;
        }

        .notification-badge.hidden {
            display: none;
        }

        @keyframes badge-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Notification Center Panel */
        .notification-center {
            position: fixed;
            top: 80px;
            right: -400px;
            width: 380px;
            max-height: calc(100vh - 100px);
            background: var(--bg-dark);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 999;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .notification-center.active {
            right: 20px;
        }

        .notif-center-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notif-center-title {
            font-size: 18px;
            font-weight: 600;
        }

        .notif-mark-read {
            background: none;
            border: none;
            color: var(--accent-primary);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
        }

        .notif-center-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .notif-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notif-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .notif-item.unread {
            border-left: 3px solid var(--accent-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .notif-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .notif-item-icon {
            font-size: 16px;
        }

        .notif-item-user {
            font-weight: 600;
            font-size: 13px;
            flex: 1;
        }

        .notif-item-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .notif-item-message {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .notif-item-action {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .notif-action-link {
            color: var(--accent-primary);
            font-size: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .notif-action-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .notification-center {
                right: -100%;
                width: calc(100% - 40px);
                max-width: 380px;
            }

            .notification-center.active {
                right: 20px;
            }
        }

        /* Task Chat Styles */
        .chat-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-danger);
            color: white;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            padding: 0 5px;
            margin-left: 6px;
        }

        .chat-badge.hidden {
            display: none;
        }

        .btn-chat {
            background: var(--accent-primary);
            color: white;
        }

        .chat-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .chat-modal.active {
            display: block;
        }

        .chat-container {
            max-width: 600px;
            margin: 20px auto;
            background: var(--bg-dark);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            max-height: 700px;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        .chat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .chat-message.own {
            align-self: flex-end;
        }

        .chat-message.other {
            align-self: flex-start;
        }

        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .chat-message.own .chat-message-header {
            justify-content: flex-end;
        }

        .chat-message-user {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .chat-message.own .chat-message-user {
            color: var(--accent-success);
        }

        .chat-message-time {
            color: var(--text-tertiary);
        }

        .chat-message-bubble {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            word-wrap: break-word;
        }

        .chat-message.own .chat-message-bubble {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent-success);
        }

        .chat-input-container {
            padding: 16px 20px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .chat-send-btn {
            background: var(--accent-primary);
            border: none;
            color: white;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-send-btn:hover {
            background: #2563eb;
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .chat-empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ===== ACTIVITY LOG STYLES ===== */
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .activity-filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .activity-filter-select {
            padding: 8px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .activity-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .activity-stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
        }

        .activity-stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .activity-stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .activity-timeline {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .activity-item:hover {
            transform: translateX(4px);
        }

        .activity-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .activity-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .activity-icon {
            font-size: 24px;
        }

        .activity-user {
            font-weight: 600;
            color: var(--text-primary);
        }

        .activity-message {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .activity-source-badge {
            background: var(--glass-bg);
            color: var(--text-tertiary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .activity-source-badge.worker {
            background: var(--accent-success);
            color: white;
        }

        .activity-time {
            text-align: right;
        }

        .activity-time-ago {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .activity-timestamp {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .activity-project {
            color: var(--text-secondary);
            font-size: 13px;
            margin-left: 36px;
        }

        .activity-details {
            margin-left: 36px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 13px;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="manager-header">
        <div class="header-row">
            <div class="manager-name" id="manager-name">Loading...</div>
            <div class="sync-status">
                <button class="notification-bell" onclick="toggleNotificationCenter()" id="notification-bell">
                    üîî
                    <span class="notification-badge" id="notification-badge">0</span>
                </button>
                <div class="status-indicator" id="sync-indicator">
                    <div class="status-dot synced" id="sync-dot"></div>
                    <span id="sync-text">Synced</span>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button class="mode-btn active" id="work-mode-btn" onclick="switchMode('work')">
                üë∑ Work Mode
            </button>
            <button class="mode-btn" id="manage-mode-btn" onclick="switchMode('manage')">
                ‚öôÔ∏è Manage
            </button>
        </div>
    </div>

    <!-- Clock Out Button (fixed, always visible when clocked in) -->
    <button class="clock-out-fixed" id="clock-out-fixed-btn" onclick="clockOut()">
        üèÅ Clock Out
    </button>

    <!-- Notification Center Panel -->
    <div class="notification-center" id="notification-center">
        <div class="notif-center-header">
            <div class="notif-center-title">Notifications</div>
            <button class="notif-mark-read" onclick="markAllAsRead()">Mark all read</button>
        </div>
        <div class="notif-center-body" id="notif-center-body">
            <div class="empty-state">
                <div class="empty-icon">üîî</div>
                <div>No notifications</div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ============================================ -->
        <!-- WORK MODE: Worker App Replica -->
        <!-- ============================================ -->
        <div id="work-mode">
            <!-- Step 1: Clock In (initial screen) -->
            <div id="clock-in-screen">
                <div class="status-card">
                    <div style="font-size: 56px; font-weight: 300; font-variant-numeric: tabular-nums; margin-bottom: 8px;" id="live-clock">00:00:00</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;" id="live-date">Loading...</div>
                    <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">Ready to Start</div>
                    <div style="color: var(--text-secondary);">Select a project to clock in</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Select Project</label>
                    <select id="project-select" onchange="enableClockIn()">
                        <option value="">-- Choose Project --</option>
                    </select>
                </div>

                <button class="big-btn success" id="clock-in-btn" onclick="clockIn()" disabled>
                    ‚è∞ Clock In to Project
                </button>
            </div>

            <!-- Step 2: Task Selection (after clock in) -->
            <div id="task-selection-screen" class="hidden">
                <div class="status-card clocked-in">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">Clocked In</div>
                    <div id="clocked-project-name" style="color: var(--text-secondary);"></div>
                </div>

                <div class="section-header">Choose Area & Task to Start</div>

                <div class="form-group">
                    <label class="form-label">Area</label>
                    <select id="area-select" onchange="loadTasksForArea()">
                        <option value="">-- Select Area --</option>
                    </select>
                </div>

                <div class="form-group" id="task-select-group">
                    <label class="form-label">Task</label>
                    <select id="task-select-dropdown">
                        <option value="">-- Select Task --</option>
                    </select>
                </div>

                <button class="big-btn primary" id="start-task-btn" onclick="startSelectedTask()" disabled>
                    ‚ñ∂Ô∏è Start Task
                </button>
            </div>

            <!-- Step 3: Active Task (working on task) -->
            <div id="active-task-screen" class="hidden">
                <div class="status-card clocked-in">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;">Currently Working On</div>
                    <div style="font-size: 20px; font-weight: 600;" id="current-task-name"></div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;" id="current-task-area"></div>
                </div>

                <!-- Task Actions -->
                <button class="big-btn warning" onclick="showReportModal()">
                    üì∏ Send Report
                </button>

                <button class="big-btn success" onclick="completeCurrentTask()">
                    ‚úÖ Complete Task
                </button>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- MANAGE MODE: Management Dashboard -->
        <!-- ============================================ -->
        <div id="manage-mode" class="hidden">
            <div class="section-header">Management Dashboard</div>

            <!-- Quick Management Actions -->
            <div class="management-grid">
                <div class="management-card" onclick="showManageAreas()">
                    <div class="management-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                    </div>
                    <div class="management-title">Areas</div>
                </div>

                <div class="management-card" onclick="showManageTasks()">
                    <div class="management-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                    </div>
                    <div class="management-title">Tasks</div>
                </div>

                <div class="management-card" onclick="showManageTools()">
                    <div class="management-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                    </div>
                    <div class="management-title">Tools</div>
                </div>

                <div class="management-card" onclick="showManageUsers()">
                    <div class="management-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div class="management-title">Users</div>
                </div>

                <div class="management-card" onclick="showActivityLog()">
                    <div class="management-icon">
                        <svg viewBox="0 0 24 24">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                    <div class="management-title">Activity Log</div>
                </div>

                <div class="management-card" onclick="openEventModal()">
                    <div class="management-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                    <div class="management-title">Create Event</div>
                </div>
            </div>

            <!-- Project Selector for Management -->
            <div class="form-group" style="margin-top: 30px;">
                <label class="form-label">Select Project to Manage</label>
                <select id="manage-project-select" onchange="loadManagementProject()">
                    <option value="">-- Choose Project --</option>
                </select>
            </div>

            <!-- Management Content Area -->
            <div id="management-content"></div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 700px; margin: 20px auto; background: var(--bg-dark); border-radius: 16px; padding: 24px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 20px;">üì∏ Send Report</h3>
                <button onclick="closeReportModal()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer; line-height: 1;">√ó</button>
            </div>

            <!-- Camera Controls -->
            <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">CAPTURE MEDIA</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn-sm btn-start" id="start-camera-btn" onclick="startCamera()">üì∑ Open Camera</button>
                    <button class="btn-sm" id="switch-camera-btn" onclick="switchCamera()" style="display: none; background: var(--accent-primary); color: white;">üîÑ Switch</button>
                    <button class="btn-sm btn-start" id="take-photo-btn" onclick="takePhoto()" style="display: none;">üì∏ Take Photo</button>
                    <button class="btn-sm btn-danger" id="start-record-btn" onclick="startRecording()" style="display: none; background: var(--accent-danger); color: white;">üé• Record Video</button>
                    <button class="btn-sm btn-danger" id="stop-record-btn" onclick="stopRecording()" style="display: none; background: var(--accent-danger); color: white;">‚èπÔ∏è Stop Recording</button>
                    <button class="btn-sm" id="close-camera-btn" onclick="closeCamera()" style="display: none; background: var(--glass-bg); border: 1px solid var(--glass-border); color: white;">‚úï Close Camera</button>
                </div>

                <!-- Video Preview -->
                <div id="camera-preview-container" style="display: none; margin-top: 16px;">
                    <video id="camera-preview" autoplay playsinline muted style="width: 100%; max-height: 350px; border-radius: 12px; background: #000;"></video>
                    <canvas id="photo-canvas" style="display: none;"></canvas>
                </div>
            </div>

            <!-- Captured Media Gallery -->
            <div id="media-gallery-container" style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary);">ATTACHED MEDIA</div>
                    <div style="font-size: 12px; color: var(--text-tertiary);" id="media-count">0 files</div>
                </div>
                <div id="media-gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;"></div>
            </div>

            <!-- Text Report -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary);">REPORT NOTES</label>
                <textarea id="report-text" placeholder="Describe the work completed, any issues, or updates..." rows="6" style="width: 100%; padding: 14px; background: rgba(21, 25, 50, 0.9); border: 1px solid var(--glass-border); border-radius: 12px; color: #ffffff; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
            </div>

            <!-- Submit -->
            <div style="display: flex; gap: 12px;">
                <button class="big-btn primary" onclick="submitReport()" style="flex: 1;">üì§ Submit Report</button>
                <button class="big-btn" onclick="closeReportModal()" style="flex: 1; background: var(--glass-bg); border: 1px solid var(--glass-border);">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Area Modal -->
    <div id="add-area-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Area</h3>
                <button class="close-btn" onclick="closeModal('add-area-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Area Name</label>
                <input type="text" id="new-area-name" placeholder="e.g., Kitchen, Lobby">
            </div>

            <div class="form-group">
                <label class="form-label">Billable</label>
                <select id="new-area-billable">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <button class="big-btn success" onclick="addArea()">
                ‚úÖ Add Area
            </button>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Task</h3>
                <button class="close-btn" onclick="closeModal('add-task-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Select Area</label>
                <select id="task-area-select">
                    <option value="">-- Choose Area --</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" id="new-task-name" placeholder="e.g., Paint walls">
            </div>

            <div class="form-group">
                <label class="form-label">Assign To</label>
                <select id="task-assignee-select">
                    <option value="">-- Select Worker --</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Priority</label>
                <select id="task-priority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <button class="big-btn success" onclick="addTask()">
                ‚úÖ Add Task
            </button>
        </div>
    </div>

    <!-- Add Tool Modal -->
    <div id="add-tool-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Tool</h3>
                <button class="close-btn" onclick="closeModal('add-tool-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Tool Name</label>
                <input type="text" id="new-tool-name" placeholder="e.g., Impact Drill">
            </div>

            <div class="form-group">
                <label class="form-label">Serial Number</label>
                <input type="text" id="new-tool-serial" placeholder="e.g., SN-12345">
            </div>

            <button class="big-btn success" onclick="addTool()">
                ‚úÖ Add Tool
            </button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New User</h3>
                <button class="close-btn" onclick="closeModal('add-user-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" id="new-user-name" placeholder="e.g., John Smith">
            </div>

            <div class="form-group">
                <label class="form-label">PIN (4 digits)</label>
                <input type="number" id="new-user-pin" placeholder="e.g., 1234" maxlength="4">
            </div>

            <div class="form-group">
                <label class="form-label">Access Level</label>
                <select id="new-user-access">
                    <option value="Worker">Worker (Worker App)</option>
                    <option value="Manager">Manager (Manager App)</option>
                    <option value="Admin">Admin (Full Hub)</option>
                </select>
            </div>

            <button class="big-btn success" onclick="addUser()">
                ‚úÖ Add User
            </button>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div id="edit-task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Task</h3>
                <button class="close-btn" onclick="closeModal('edit-task-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Task Name</label>
                <input type="text" id="edit-task-name" placeholder="e.g., Paint walls">
            </div>

            <div class="form-group">
                <label class="form-label">Assign to Team Members</label>
                <div id="edit-task-assignees" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 12px; max-height: 200px; overflow-y: auto;">
                    <!-- Team member checkboxes will be populated here -->
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Priority</label>
                <select id="edit-task-priority">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <button class="big-btn success" onclick="updateTask()">
                ‚úÖ Update Task
            </button>
        </div>
    </div>

    <!-- Edit Area Modal -->
    <div id="edit-area-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Area</h3>
                <button class="close-btn" onclick="closeModal('edit-area-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Area Name</label>
                <input type="text" id="edit-area-name" placeholder="e.g., Kitchen, Lobby">
            </div>

            <div class="form-group">
                <label class="form-label">Billable</label>
                <select id="edit-area-billable">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <button class="big-btn success" onclick="updateArea()">
                ‚úÖ Update Area
            </button>
        </div>
    </div>

    <!-- Edit Tool Modal -->
    <div id="edit-tool-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Tool</h3>
                <button class="close-btn" onclick="closeModal('edit-tool-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Tool Name</label>
                <input type="text" id="edit-tool-name" placeholder="e.g., Impact Drill">
            </div>

            <div class="form-group">
                <label class="form-label">Serial Number</label>
                <input type="text" id="edit-tool-serial" placeholder="e.g., SN-12345">
            </div>

            <button class="big-btn success" onclick="updateTool()">
                ‚úÖ Update Tool
            </button>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="close-btn" onclick="closeModal('edit-user-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" id="edit-user-name" placeholder="e.g., John Smith">
            </div>

            <div class="form-group">
                <label class="form-label">PIN (4 digits)</label>
                <input type="number" id="edit-user-pin" placeholder="e.g., 1234" maxlength="4">
            </div>

            <div class="form-group">
                <label class="form-label">Access Level</label>
                <select id="edit-user-access">
                    <option value="Worker">Worker (Worker App)</option>
                    <option value="Manager">Manager (Manager App)</option>
                    <option value="Admin">Admin (Full Hub)</option>
                </select>
            </div>

            <button class="big-btn success" onclick="updateUser()">
                ‚úÖ Update User
            </button>
        </div>
    </div>

    <!-- Calendar Event Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Calendar Event</h3>
                <button class="close-btn" onclick="closeModal('event-modal')">√ó</button>
            </div>

            <div class="form-group">
                <label class="form-label">Event Title</label>
                <input type="text" id="event-title" placeholder="Enter event title">
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="event-date">
            </div>

            <div class="form-group">
                <label class="form-label">Time</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="time" id="event-start-time" value="09:00">
                    <span>to</span>
                    <input type="time" id="event-end-time" value="10:00">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Attendees (Hold Ctrl/Cmd to select multiple)</label>
                <select id="event-attendees" multiple style="height: 120px; padding: 4px;">
                    <optgroup label="Our Team" id="event-our-team"></optgroup>
                    <optgroup label="Client Team" id="event-client-team"></optgroup>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="event-description" placeholder="Optional event description" rows="3"></textarea>
            </div>

            <button class="big-btn success" onclick="createCalendarEvent()">
                üìÖ Create Event & Send Invites
            </button>
        </div>
    </div>

    <!-- Task Chat Modal -->
    <div id="task-chat-modal" class="chat-modal">
        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <div class="chat-title" id="chat-task-name">Task Chat</div>
                    <div class="chat-subtitle" id="chat-task-info"></div>
                </div>
                <button class="chat-close" onclick="closeTaskChat()">√ó</button>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="chat-empty">
                    <div class="chat-empty-icon">üí¨</div>
                    <div>No messages yet</div>
                    <div style="font-size: 13px; margin-top: 8px;">Start a conversation about this task</div>
                </div>
            </div>

            <div class="chat-input-container">
                <textarea
                    class="chat-input"
                    id="chat-input"
                    placeholder="Type your message..."
                    rows="1"
                    onkeydown="handleChatKeydown(event)"></textarea>
                <button class="emoji-btn" onclick="toggleEmojiPicker(event)" title="Add emoji" style="background: transparent; border: none; font-size: 24px; cursor: pointer; padding: 8px; transition: transform 0.2s;" onmouseenter="this.style.transform='scale(1.2)'" onmouseleave="this.style.transform='scale(1)'">
                    üòÄ
                </button>
                <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // ===== GOOGLE DRIVE & APIS CONFIGURATION =====
        const CLIENT_ID = '904576712649-mcrh6cl8ei84gktkfg2f36eqc8454k1q.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBoEAEz1NnCJDQ221u4XxXZIBaQrN-nlAc';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Global State
        let currentUser = null;
        let hubState = null;
        let selectedProject = null;
        let managementProject = null;
        let currentTask = null;
        let clockedInTime = null;
        let currentMode = 'work'; // 'work' or 'manage'

        // Camera & Media State
        let cameraStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isFrontCamera = false;
        let capturedMedia = []; // Array to store multiple media files: [{blob, filename, type, preview}]

        // Real-Time Chat System
        let chatSystem = null;
        let activeChatListener = null;

        // Emoji Picker
        let emojiPicker = null;

        // Firebase Operations
        let firebaseOps = null;

        // Edit state tracking
        let editingTaskAreaId = null;
        let editingTaskWbs = null;
        let editingAreaId = null;
        let editingToolId = null;
        let editingUserId = null;

        // BroadcastChannel for instant state sync with hub
        const stateChannel = new BroadcastChannel('pm_hub_state');

        // Track which management view is currently active
        let currentManagementView = null; // 'tasks', 'areas', 'tools', 'users', or null

        // Chat state tracking
        let currentChatTask = null; // Store task being chatted about

        // Listen for state updates from hub
        stateChannel.onmessage = function(event) {
            if (event.data.type === 'STATE_UPDATED') {
                console.log('üì° Manager: State update received from', event.data.source);
                loadHubState();

                // Refresh current view
                if (currentMode === 'work') {
                    // Refresh work mode if needed
                    if (selectedProject) {
                        selectedProject = hubState.projects?.find(p => p.id == selectedProject.id);
                    }
                } else if (currentMode === 'manage') {
                    // Refresh management view if needed
                    if (managementProject) {
                        managementProject = hubState.projects?.find(p => p.id == managementProject.id);

                        // Refresh the currently active management view
                        if (currentManagementView === 'tasks') {
                            showManageTasks();
                        } else if (currentManagementView === 'areas') {
                            showManageAreas();
                        } else if (currentManagementView === 'tools') {
                            showManageTools();
                        } else if (currentManagementView === 'users') {
                            showManageUsers();
                        } else if (currentManagementView === 'activity') {
                            renderManagerActivityFeed();
                            console.log('üìä Manager: Activity log refreshed via BroadcastChannel');
                        }

                        // Chat messages are now handled by real-time Firebase listeners
                        // No manual refresh needed
                    }
                }
            }
        };

        // ===== MODE SWITCHING =====
        function switchMode(mode) {
            currentMode = mode;

            document.getElementById('work-mode-btn').classList.toggle('active', mode === 'work');
            document.getElementById('manage-mode-btn').classList.toggle('active', mode === 'manage');

            document.getElementById('work-mode').classList.toggle('hidden', mode !== 'work');
            document.getElementById('manage-mode').classList.toggle('hidden', mode !== 'manage');

            // Hide clock out button in manage mode
            if (mode === 'manage') {
                document.getElementById('clock-out-fixed-btn').style.display = 'none';
            } else if (clockedInTime) {
                document.getElementById('clock-out-fixed-btn').style.display = 'block';
            }

            // Load management projects if switching to manage mode
            if (mode === 'manage') {
                loadManagementProjects();
            }
        }

        // ===== INITIALIZATION =====
        function init() {
            // Get current user from login
            const userStr = localStorage.getItem('pm_hub_current_user');
            if (!userStr) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(userStr);

            // Verify user is a manager
            if (currentUser.accessLevel !== 'Manager') {
                alert('Access denied. Manager account required.');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('manager-name').textContent = currentUser.name;

            // Start live clock
            startLiveClock();

            // Initialize Google APIs
            initGoogleAPIs();

            // Load hub state
            loadHubState();

            // Load notifications
            loadNotifications();

            // Check if already clocked in
            checkClockStatus();

            // Load projects
            loadProjects();

            // Initialize Real-Time Chat System
            initializeChatSystem();
        }

        function initializeChatSystem() {
            // Wait for Firebase to be ready
            setTimeout(() => {
                if (window.firebaseEnabled && window.db && window.firestore && typeof PMHubChat !== 'undefined') {
                    chatSystem = new PMHubChat({
                        db: window.db,
                        firestore: window.firestore,
                        currentUser: currentUser,
                        onMessageReceived: (message) => {
                            // Show notification for new messages
                            console.log('üí¨ New message received:', message);
                        },
                        onUnreadCountChanged: (projectId, areaId, taskWbs, count) => {
                            // Update unread badge if needed
                            console.log(`üí¨ Unread count for ${taskWbs}: ${count}`);
                        }
                    });
                    console.log('‚úì Manager: Real-time chat system initialized');
                } else {
                    console.warn('‚ö†Ô∏è Manager: Chat system not available - Firebase or PMHubChat not loaded');
                }

                // Initialize emoji picker
                if (typeof PMHubEmojiPicker !== 'undefined') {
                    emojiPicker = new PMHubEmojiPicker({
                        onEmojiSelect: (emoji) => {
                            console.log('üòÄ Emoji selected:', emoji);
                        }
                    });
                    console.log('‚úì Manager: Emoji picker initialized');
                }

                // Initialize Firebase operations
                if (window.firebaseEnabled && window.db && window.firestore && typeof PMHubFirebase !== 'undefined') {
                    firebaseOps = new PMHubFirebase({
                        db: window.db,
                        firestore: window.firestore,
                        currentUser: currentUser
                    });
                    console.log('‚úì Manager: Firebase operations initialized');
                } else {
                    console.warn('‚ö†Ô∏è Manager: Firebase operations not available');
                }
            }, 1000);
        }

        function toggleEmojiPicker(event) {
            event.preventDefault();
            event.stopPropagation();

            if (!emojiPicker && typeof PMHubEmojiPicker !== 'undefined') {
                emojiPicker = new PMHubEmojiPicker({
                    onEmojiSelect: (emoji) => {
                        console.log('üòÄ Emoji selected:', emoji);
                    }
                });
            }

            if (emojiPicker) {
                const chatInput = document.getElementById('chat-input');
                const emojiBtn = event.currentTarget;
                emojiPicker.toggle(chatInput, emojiBtn);
            }
        }

        // Live Clock Functions
        function startLiveClock() {
            updateLiveClock();
            setInterval(updateLiveClock, 1000);
        }

        function updateLiveClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const clockEl = document.getElementById('live-clock');
            if (clockEl) {
                clockEl.textContent = `${hours}:${minutes}:${seconds}`;
            }

            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateEl = document.getElementById('live-date');
            if (dateEl) {
                dateEl.textContent = now.toLocaleDateString('en-US', options);
            }
        }

        function loadHubState() {
            const stateStr = localStorage.getItem('pmSystemState');
            if (stateStr) {
                hubState = JSON.parse(stateStr);
            } else {
                hubState = { projects: [], tools: [], timeEntries: [], activities: [], reports: [], ourTeam: [], clientTeam: [] };
            }
        }

        async function saveHubState(section = 'general') {
            hubState.isOnline = navigator.onLine;
            localStorage.setItem('pmSystemState', JSON.stringify(hubState));

            // Sync to Firebase if enabled
            if (window.firebaseEnabled && window.db) {
                try {
                    const cleanData = {
                        projects: Array.isArray(hubState.projects) ? hubState.projects : [],
                        ourTeam: Array.isArray(hubState.ourTeam) ? hubState.ourTeam : [],
                        clientTeam: Array.isArray(hubState.clientTeam) ? hubState.clientTeam : [],
                        tools: Array.isArray(hubState.tools) ? hubState.tools : [],
                        activities: Array.isArray(hubState.activities) ? hubState.activities.slice(0, 100) : [],
                        reports: Array.isArray(hubState.reports) ? hubState.reports.slice(0, 50) : [],
                        timeEntries: Array.isArray(hubState.timeEntries) ? hubState.timeEntries : [],
                        lastModified: new Date().toISOString(),
                        lastSyncedBy: currentUser ? currentUser.name : 'manager'
                    };

                    await window.firestore.setDoc(
                        window.firestore.doc(window.db, 'hubs', 'main'),
                        cleanData,
                        { merge: true }
                    );
                } catch (error) {
                    console.error('Firebase sync error:', error);
                }
            }

            // Get latest activity for notification
            const lastActivity = hubState.activities?.[hubState.activities.length - 1];

            // Broadcast state change
            stateChannel.postMessage({
                type: 'STATE_UPDATED',
                section: section,
                timestamp: Date.now(),
                source: 'manager',
                syncedBy: currentUser ? currentUser.name : 'manager',
                activity: lastActivity
            });

            // Also broadcast via realtime module for enhanced notifications
            if (window.pmRealtime && lastActivity) {
                window.pmRealtime.broadcast(section, lastActivity);
            }
        }

        // ===== GOOGLE DRIVE INTEGRATION =====
        function initGoogleAPIs() {
            if (typeof gapi !== 'undefined') {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                        });
                        gapiInited = true;

                        const loginToken = localStorage.getItem('drive_token_from_login');
                        if (loginToken) {
                            gapi.client.setToken({ access_token: loginToken });
                            accessToken = loginToken;
                        }
                    } catch (error) {
                        console.error('GAPI init error:', error);
                    }
                });
            }

            if (typeof google !== 'undefined' && google.accounts) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        accessToken = tokenResponse.access_token;
                    }
                });
                gisInited = true;
            }
        }

        // ===== WORK MODE FUNCTIONS (Worker App Replica) =====
        function checkClockStatus() {
            if (!hubState.timeEntries) hubState.timeEntries = [];

            const today = new Date().toDateString();
            const todayEntries = hubState.timeEntries.filter(e =>
                e.userId === currentUser.id &&
                new Date(e.timestamp).toDateString() === today
            );

            const lastEntry = todayEntries[todayEntries.length - 1];
            if (lastEntry && lastEntry.type === 'in') {
                selectedProject = hubState.projects.find(p => p.id == lastEntry.projectId);
                clockedInTime = new Date(lastEntry.timestamp);
                showTaskSelection();
                document.getElementById('clock-out-fixed-btn').style.display = 'block';
            }
        }

        function loadProjects() {
            const select = document.getElementById('project-select');
            select.innerHTML = '<option value="">-- Choose Project --</option>';

            if (hubState.projects) {
                hubState.projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            }
        }

        function enableClockIn() {
            const projectId = document.getElementById('project-select').value;
            document.getElementById('clock-in-btn').disabled = !projectId;
        }

        async function clockIn() {
            const projectId = document.getElementById('project-select').value;
            if (!projectId) return;

            selectedProject = hubState.projects.find(p => p.id == projectId);
            clockedInTime = new Date();

            const timeEntry = {
                id: Date.now().toString(),
                userId: currentUser.id,
                userName: currentUser.name,
                projectId: projectId,
                type: 'in',
                timestamp: clockedInTime.toISOString()
            };

            // üî• REAL-TIME: Write directly to Firebase
            if (firebaseOps) {
                console.log('üî• Manager: Writing clock-in to Firebase in real-time');
                const success = await firebaseOps.addTimeEntry(timeEntry);
                if (success) {
                    await firebaseOps.logActivity('CLOCK_IN', `Manager clocked in to ${selectedProject.name}`);
                    console.log('‚úÖ Manager: Clock-in synced to Firebase - Hub & Worker will see this instantly!');
                    showToast('Clocked in successfully - synced across all apps', 'success');
                } else {
                    showToast('Clock-in saved locally - will sync when connection is restored', 'warning');
                }
            } else {
                // Fallback to localStorage
                if (!hubState.timeEntries) hubState.timeEntries = [];
                hubState.timeEntries.push(timeEntry);
                logActivity('CLOCK_IN', `Clocked in to ${selectedProject.name}`);
                await saveHubState();
            }

            showTaskSelection();
            document.getElementById('clock-out-fixed-btn').style.display = 'block';
        }

        function showTaskSelection() {
            document.getElementById('clock-in-screen').classList.add('hidden');
            document.getElementById('active-task-screen').classList.add('hidden');
            document.getElementById('task-selection-screen').classList.remove('hidden');
            document.getElementById('clocked-project-name').textContent = selectedProject.name;

            const areaSelect = document.getElementById('area-select');
            areaSelect.innerHTML = '<option value="">-- Select Area --</option>';

            if (selectedProject.areas) {
                selectedProject.areas.forEach(area => {
                    areaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
                });
            }
        }

        function loadTasksForArea() {
            const areaId = document.getElementById('area-select').value;
            const taskSelect = document.getElementById('task-select-dropdown');
            const startBtn = document.getElementById('start-task-btn');

            if (!areaId) {
                startBtn.disabled = true;
                return;
            }

            const area = selectedProject.areas.find(a => a.id == areaId);
            if (!area || !area.tasks || area.tasks.length === 0) {
                startBtn.disabled = false;
                return;
            }

            taskSelect.innerHTML = '<option value="">-- Select Task --</option>';

            area.tasks.forEach(task => {
                if (!task.completed) {
                    const priorityIcon = task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : 'üü¢';
                    taskSelect.innerHTML += `<option value="${task.wbs}">${priorityIcon} ${task.wbs} - ${task.name}</option>`;
                }
            });

            taskSelect.onchange = () => {
                startBtn.disabled = !taskSelect.value;
            };
        }

        async function startSelectedTask() {
            const areaId = document.getElementById('area-select').value;
            if (!areaId) return;

            const project = hubState.projects.find(p => p.id == selectedProject.id);
            const area = project.areas.find(a => a.id == areaId);
            const taskWbs = document.getElementById('task-select-dropdown').value;

            if (taskWbs) {
                const task = area.tasks.find(t => t.wbs == taskWbs);
                if (!task) return;

                currentTask = {
                    ...task,
                    projectId: project.id,
                    projectName: project.name,
                    areaId: areaId,
                    areaName: area.name
                };

                // üî• REAL-TIME: Write task status directly to Firebase
                if (firebaseOps) {
                    console.log('üî• Manager: Starting task in Firebase - Hub & Worker will see this instantly!');
                    const success = await firebaseOps.updateTask(
                        project.id,
                        areaId,
                        taskWbs,
                        {
                            status: 'progress',
                            startedAt: new Date().toISOString(),
                            startedBy: currentUser.name
                        },
                        'TASK_START',
                        `Manager started: ${task.name}`
                    );

                    if (success) {
                        task.status = 'progress';
                        task.startedAt = currentTask.startedAt || new Date().toISOString();
                        task.startedBy = currentUser.name;
                        console.log('‚úÖ Manager: Task started and synced in real-time!');
                        showToast(`Task started - Hub & Worker updated instantly!`, 'success');
                    } else {
                        showToast('Task started locally - will sync when connection restored', 'warning');
                    }
                } else {
                    // Fallback to localStorage
                    task.status = 'progress';
                    task.startedAt = new Date().toISOString();
                    task.startedBy = currentUser.name;
                    logActivity('TASK_START', `Started: ${task.name}`);
                    await saveHubState('projects');
                }
            } else {
                currentTask = {
                    projectId: project.id,
                    projectName: project.name,
                    areaId: areaId,
                    areaName: area.name,
                    wbs: null,
                    name: area.name
                };

                if (firebaseOps) {
                    await firebaseOps.logActivity('TASK_START', `Manager started working on: ${area.name}`);
                } else {
                    logActivity('TASK_START', `Started working on: ${area.name}`);
                }
            }

            showActiveTask();
        }

        function showActiveTask() {
            document.getElementById('task-selection-screen').classList.add('hidden');
            document.getElementById('active-task-screen').classList.remove('hidden');
            document.getElementById('current-task-name').textContent = currentTask.name;
            document.getElementById('current-task-area').textContent = `Area: ${currentTask.areaName}`;
        }

        async function completeCurrentTask() {
            if (!currentTask) return;

            const project = hubState.projects.find(p => p.id == currentTask.projectId);
            const area = project.areas.find(a => a.id == currentTask.areaId);

            if (currentTask.wbs) {
                const task = area.tasks.find(t => t.wbs == currentTask.wbs);
                if (task) {
                    let actualHours = task.estimatedHours || 0;
                    if (task.startedAt) {
                        const started = new Date(task.startedAt);
                        const completed = new Date();
                        const hoursWorked = (completed - started) / (1000 * 60 * 60);
                        actualHours = Math.round(hoursWorked * 10) / 10;
                    }

                    const completedAt = new Date().toISOString();
                    const variance = task.estimatedHours ? actualHours - task.estimatedHours : 0;

                    // üî• REAL-TIME: Write task completion directly to Firebase
                    if (firebaseOps) {
                        console.log('üî• Manager: Completing task in Firebase - Hub & Worker will see this instantly!');
                        const success = await firebaseOps.updateTask(
                            project.id,
                            currentTask.areaId,
                            currentTask.wbs,
                            {
                                status: 'done',
                                completed: true,
                                completedAt: completedAt,
                                completedBy: currentUser.name,
                                actualHours: actualHours
                            },
                            'TASK_COMPLETE',
                            `Manager completed: ${task.name} (${actualHours}h)`
                        );

                        if (success) {
                            task.status = 'done';
                            task.completed = true;
                            task.completedAt = completedAt;
                            task.completedBy = currentUser.name;
                            task.actualHours = actualHours;
                            console.log('‚úÖ Manager: Task completed and synced in real-time!');
                            showToast(`Task completed - Hub & Worker updated instantly! (${actualHours}h)`, 'success');

                            // Log detailed analytics
                            await firebaseOps.logActivity('TASK_COMPLETE_DETAILED', `Manager completed task with analytics`, {
                                taskWbs: currentTask.wbs,
                                taskName: task.name,
                                projectId: project.id,
                                projectName: project.name,
                                areaId: currentTask.areaId,
                                areaName: area.name,
                                billable: area.billable,
                                actualHours: actualHours,
                                estimatedHours: task.estimatedHours || 0,
                                variance: variance,
                                completedBy: currentUser.name,
                                completedAt: completedAt,
                                startedAt: task.startedAt
                            });

                            // Check if area complete
                            const allTasks = area.tasks || [];
                            const completedTasks = allTasks.filter(t => t.completed);
                            if (allTasks.length > 0 && completedTasks.length === allTasks.length) {
                                const totalHours = allTasks.reduce((sum, t) => sum + (t.actualHours || 0), 0);
                                await firebaseOps.logActivity('AREA_COMPLETE', `Manager completed area "${area.name}"`, {
                                    areaId: currentTask.areaId,
                                    areaName: area.name,
                                    billable: area.billable,
                                    requiresInvoice: area.billable,
                                    totalHours: totalHours,
                                    tasksCompleted: allTasks.length,
                                    projectId: project.id,
                                    projectName: project.name
                                });
                                showToast(`üéâ Area "${area.name}" is 100% complete!`, 'success', 3000);
                            }
                        } else {
                            showToast('Task completed locally - will sync when connection restored', 'warning');
                        }
                    } else {
                        // Fallback to localStorage
                        task.status = 'done';
                        task.completed = true;
                        task.completedAt = completedAt;
                        task.completedBy = currentUser.name;
                        task.actualHours = actualHours;
                        logActivity('TASK_COMPLETE', `Completed: ${task.name}`, { hours: actualHours });
                        await saveHubState('projects');
                    }
                }
            }

            currentTask = null;
            showTaskSelection();
        }

        function showReportModal() {
            document.getElementById('report-modal').style.display = 'block';
            document.getElementById('report-text').value = '';
        }

        function closeReportModal() {
            document.getElementById('report-modal').style.display = 'none';
            closeCamera();
            capturedMedia = [];
            document.getElementById('report-text').value = '';
            resetCameraUI();
        }

        function resetCameraUI() {
            document.getElementById('start-camera-btn').style.display = 'inline-block';
            document.getElementById('switch-camera-btn').style.display = 'none';
            document.getElementById('take-photo-btn').style.display = 'none';
            document.getElementById('start-record-btn').style.display = 'none';
            document.getElementById('stop-record-btn').style.display = 'none';
            document.getElementById('close-camera-btn').style.display = 'none';
            document.getElementById('camera-preview-container').style.display = 'none';
            document.getElementById('media-gallery-container').style.display = 'none';
        }

        function updateMediaGallery() {
            if (capturedMedia.length === 0) {
                document.getElementById('media-gallery-container').style.display = 'none';
                return;
            }

            document.getElementById('media-gallery-container').style.display = 'block';
            const count = document.getElementById('media-count');
            count.textContent = `${capturedMedia.length} file${capturedMedia.length > 1 ? 's' : ''}`;

            const gallery = document.getElementById('media-gallery');
            gallery.innerHTML = capturedMedia.map((media, index) => {
                const icon = media.type === 'photo' ? 'üì∏' : 'üé•';
                return `
                    <div style="position: relative; border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3);">
                        ${media.type === 'photo'
                            ? `<img src="${media.preview}" style="width: 100%; height: 120px; object-fit: cover;">`
                            : `<video src="${media.preview}" style="width: 100%; height: 120px; object-fit: cover;"></video>`
                        }
                        <button onclick="removeMedia(${index})" style="position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                        <div style="position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${icon}</div>
                    </div>
                `;
            }).join('');
        }

        function removeMedia(index) {
            capturedMedia.splice(index, 1);
            updateMediaGallery();
            showToast('Media removed', 'info', 1500);
        }

        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            const video = document.getElementById('camera-preview');
            if (video) {
                video.srcObject = null;
                video.pause();
            }
            resetCameraUI();
        }

        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: isFrontCamera ? 'user' : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                };

                console.log('üì∑ Manager: Starting camera...');
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);

                const video = document.getElementById('camera-preview');
                video.srcObject = cameraStream;

                video.setAttribute('autoplay', '');
                video.setAttribute('playsinline', '');
                video.setAttribute('muted', '');

                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = async () => {
                        try {
                            await video.play();
                            console.log('‚úì Video playing');
                            resolve();
                        } catch (err) {
                            console.error('Video play error:', err);
                            reject(err);
                        }
                    };
                });

                document.getElementById('camera-preview-container').style.display = 'block';
                document.getElementById('start-camera-btn').style.display = 'none';
                document.getElementById('switch-camera-btn').style.display = 'inline-block';
                document.getElementById('take-photo-btn').style.display = 'inline-block';
                document.getElementById('start-record-btn').style.display = 'inline-block';
                document.getElementById('close-camera-btn').style.display = 'inline-block';

                console.log('‚úì Manager: Camera started successfully');
            } catch (error) {
                console.error('‚ùå Camera error:', error);
                let errorMessage = 'Camera error: ';

                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Permission denied. Please allow camera access.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Camera is already in use by another app.';
                } else {
                    errorMessage += error.message;
                }

                alert(errorMessage);
            }
        }

        function switchCamera() {
            isFrontCamera = !isFrontCamera;
            closeCamera();
            startCamera();
        }

        function takePhoto() {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('photo-canvas');

            if (video.readyState < 2) {
                alert('‚ö†Ô∏è Camera not ready yet. Please wait a moment.');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            canvas.toBlob((blob) => {
                if (!blob) {
                    alert('‚ùå Failed to capture photo. Please try again.');
                    return;
                }

                const now = new Date();
                const filename = `photo_${now.toISOString().replace(/[:.]/g,'-')}.jpg`;
                const preview = URL.createObjectURL(blob);

                capturedMedia.push({
                    blob: blob,
                    filename: filename,
                    type: 'photo',
                    preview: preview
                });

                updateMediaGallery();
                showToast('Photo captured! Take more or submit report.', 'success', 2000);
            }, 'image/jpeg', 0.92);
        }

        function startRecording() {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(cameraStream, { mimeType: 'video/webm; codecs=vp8' });

            mediaRecorder.ondataavailable = (e) => {
                if (e.data && e.data.size) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                if (recordedChunks.length === 0) {
                    alert('‚ùå No video data recorded. Please try again.');
                    return;
                }

                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const now = new Date();
                const filename = `video_${now.toISOString().replace(/[:.]/g,'-')}.webm`;
                const preview = URL.createObjectURL(blob);

                capturedMedia.push({
                    blob: blob,
                    filename: filename,
                    type: 'video',
                    preview: preview
                });

                updateMediaGallery();
                showToast('Video recorded! Capture more or submit report.', 'success', 2000);

                document.getElementById('start-record-btn').style.display = 'inline-block';
                document.getElementById('stop-record-btn').style.display = 'none';
            };

            mediaRecorder.start();
            document.getElementById('start-record-btn').style.display = 'none';
            document.getElementById('stop-record-btn').style.display = 'inline-block';
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        async function submitReport() {
            const text = document.getElementById('report-text').value.trim();

            if (!text && capturedMedia.length === 0) {
                alert('Please enter text or capture media');
                return;
            }

            // Show loading indicator
            const submitBtn = document.querySelector('#report-modal .big-btn.primary');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.textContent = '‚è≥ Uploading...';
                submitBtn.disabled = true;
            }

            // Upload media to Drive if exists
            let uploadedFiles = [];
            let mediaStoredLocally = false;
            let reportsFolderId = null;

            if (capturedMedia.length > 0 && window.gapi && accessToken) {
                console.log('üì§ Manager: Uploading', capturedMedia.length, 'media files to Drive');

                // Get task drive folder (same pattern as Worker)
                const folderId = await getTaskDriveFolder();
                reportsFolderId = folderId;

                if (folderId) {
                    // Upload text as .txt file if exists
                    if (text) {
                        try {
                            const now = new Date();
                            const textFilename = `report_${now.toISOString().replace(/[:.]/g,'-')}.txt`;
                            const reportContent = `Project Management System - Manager Report
Generated: ${now.toLocaleString()}
Manager: ${currentUser.name}
Project: ${selectedProject ? selectedProject.name : 'N/A'}
Task: ${currentTask ? currentTask.name : 'General'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
REPORT:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

${text}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
End of Report
`;
                            const textBlob = new Blob([reportContent], { type: 'text/plain' });
                            const uploadResult = await uploadToGoogleDrive(textBlob, textFilename, folderId);

                            if (uploadResult && uploadResult.id) {
                                uploadedFiles.push({
                                    filename: textFilename,
                                    driveFileId: uploadResult.id,
                                    type: 'text'
                                });
                                console.log('‚úÖ Text report uploaded!');
                            }
                        } catch (error) {
                            console.error('‚ùå Text upload failed:', error);
                            mediaStoredLocally = true;
                        }
                    }

                    // Upload each media file
                    for (let i = 0; i < capturedMedia.length; i++) {
                        const media = capturedMedia[i];
                        try {
                            const uploadResult = await uploadToGoogleDrive(media.blob, media.filename, folderId);

                            if (uploadResult && uploadResult.id) {
                                uploadedFiles.push({
                                    filename: media.filename,
                                    driveFileId: uploadResult.id,
                                    type: media.type
                                });
                                console.log(`‚úÖ File ${i+1}/${capturedMedia.length} uploaded`);
                            }
                        } catch (error) {
                            console.error(`‚ùå Upload failed for file ${i+1}:`, error);
                            mediaStoredLocally = true;
                        }
                    }

                    if (uploadedFiles.length > 0) {
                        showToast(`${uploadedFiles.length} file(s) uploaded to Drive!`, 'success');
                    }
                }
            }

            const report = {
                id: Date.now().toString(),
                userId: currentUser.id,
                userName: currentUser.name,
                projectId: currentTask ? currentTask.projectId : selectedProject?.id,
                projectName: currentTask ? currentTask.projectName : selectedProject?.name,
                areaId: currentTask ? currentTask.areaId : null,
                areaName: currentTask ? currentTask.areaName : null,
                taskId: currentTask ? currentTask.wbs : null,
                taskName: currentTask ? currentTask.name : null,
                text: text,
                mediaFiles: uploadedFiles,
                mediaCount: capturedMedia.length,
                uploadedCount: uploadedFiles.length,
                mediaStoredLocally: mediaStoredLocally,
                reportsFolderId: reportsFolderId,
                timestamp: new Date().toISOString(),
                source: 'manager'
            };

            // üî• REAL-TIME: Write report directly to Firebase
            if (firebaseOps) {
                console.log('üî• Manager: Submitting report to Firebase - Hub & Worker will see this instantly!');
                const success = await firebaseOps.addPhotoReport(report);
                if (success) {
                    console.log('‚úÖ Manager: Report synced to Firebase in real-time!');
                    showToast('Report submitted - synced across all apps!', 'success');
                } else {
                    showToast('Report saved locally - will sync when connection restored', 'warning');
                }
            } else {
                // Fallback to localStorage
                if (!hubState.reports) hubState.reports = [];
                hubState.reports.push(report);
                logActivity('REPORT', text || 'Media report', {
                    projectId: report.projectId,
                    projectName: report.projectName,
                    taskId: report.taskId,
                    taskName: report.taskName,
                    mediaCount: capturedMedia.length
                });
                await saveHubState();
                showToast('Report submitted!', 'success');
            }

            // Reset button state
            if (submitBtn) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }

            closeReportModal();
        }

        async function uploadToGoogleDrive(blob, filename, folderId) {
            if (!accessToken) {
                console.error('No access token for Drive upload');
                return null;
            }

            const metadata = {
                name: filename,
                parents: folderId ? [folderId] : []
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });

                return await response.json();
            } catch (error) {
                console.error('Upload error:', error);
                return null;
            }
        }

        async function getTaskDriveFolder() {
            if (!currentTask && !selectedProject) {
                console.warn('No task or project selected');
                return null;
            }

            loadHubState();

            const projectId = currentTask ? currentTask.projectId : selectedProject.id;
            const project = hubState.projects?.find(p => p.id == projectId);

            if (!project) {
                console.error('Project not found');
                return null;
            }

            if (currentTask) {
                const area = project.areas?.find(a => a.id == currentTask.areaId);
                if (area && area.tasks) {
                    const task = area.tasks.find(t => t.wbs == currentTask.wbs);
                    if (task && task.reportsFolderId) {
                        return task.reportsFolderId;
                    }
                    if (area.driveFolderId) {
                        return area.driveFolderId;
                    }
                }
            }

            // Fallback to project folder
            return project.driveFolderId || null;
        }

        async function clockOut() {
            const clockOutTime = new Date();
            const hoursWorked = clockedInTime ? (clockOutTime - clockedInTime) / (1000 * 60 * 60) : 0;
            const hoursWorkedFormatted = Math.round(hoursWorked * 10) / 10;

            // Calculate daily summary
            const today = new Date().toISOString().split('T')[0];
            const todayActivities = (hubState.activityLog || []).filter(a =>
                a.userId === currentUser.id &&
                a.timestamp?.startsWith(today)
            );

            const tasksCompletedToday = todayActivities.filter(a => a.type === 'TASK_COMPLETE' || a.type === 'TASK_COMPLETE_DETAILED').length;
            const reportsSubmittedToday = todayActivities.filter(a => a.type === 'REPORT').length;

            const timeEntry = {
                id: Date.now().toString(),
                userId: currentUser.id,
                userName: currentUser.name,
                projectId: selectedProject.id,
                type: 'out',
                timestamp: clockOutTime.toISOString()
            };

            // üî• REAL-TIME: Write clock-out directly to Firebase
            if (firebaseOps) {
                console.log('üî• Manager: Writing clock-out to Firebase in real-time');
                const success = await firebaseOps.addTimeEntry(timeEntry);
                if (success) {
                    await firebaseOps.logActivity('CLOCK_OUT',
                        `Manager clocked out from ${selectedProject.name} (${hoursWorkedFormatted}h worked, ${tasksCompletedToday} tasks completed)`,
                        {
                            projectId: selectedProject.id,
                            projectName: selectedProject.name,
                            hoursWorked: hoursWorkedFormatted,
                            tasksCompleted: tasksCompletedToday,
                            reportsSubmitted: reportsSubmittedToday
                        }
                    );
                    console.log('‚úÖ Manager: Clock-out synced to Firebase');
                    showToast(`Clocked out - ${hoursWorkedFormatted}h worked today!`, 'success');
                } else {
                    showToast('Clock-out saved locally - will sync when connection restored', 'warning');
                }
            } else {
                // Fallback to localStorage
                if (!hubState.timeEntries) hubState.timeEntries = [];
                hubState.timeEntries.push(timeEntry);
                logActivity('CLOCK_OUT', `Clocked out from ${selectedProject.name}`);
                await saveHubState();
            }

            // Reset state
            selectedProject = null;
            currentTask = null;
            clockedInTime = null;

            // Return to clock-in screen
            document.getElementById('task-selection-screen').classList.add('hidden');
            document.getElementById('active-task-screen').classList.add('hidden');
            document.getElementById('clock-out-fixed-btn').style.display = 'none';
            document.getElementById('clock-in-screen').classList.remove('hidden');

            // Refresh project list
            loadProjects();
        }

        // ===== MANAGEMENT MODE FUNCTIONS =====
        function loadManagementProjects() {
            const select = document.getElementById('manage-project-select');
            select.innerHTML = '<option value="">-- Choose Project --</option>';

            if (hubState.projects) {
                hubState.projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            }
        }

        function loadManagementProject() {
            const projectId = document.getElementById('manage-project-select').value;
            if (!projectId) {
                document.getElementById('management-content').innerHTML = '';
                return;
            }

            managementProject = hubState.projects.find(p => p.id == projectId);
        }

        // ===== MANAGE AREAS =====
        function showManageAreas() {
            if (!managementProject) {
                showToast('Please select a project first', 'warning');
                return;
            }

            currentManagementView = 'areas';
            const areas = managementProject.areas || [];
            let html = `
                <div class="section-header">Areas for ${managementProject.name}</div>
                <button class="big-btn primary" onclick="openModal('add-area-modal')">
                    ‚ûï Add New Area
                </button>
            `;

            if (areas.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">üìç</div><div>No areas yet</div></div>`;
            } else {
                areas.forEach(area => {
                    html += `
                        <div class="list-item">
                            <div class="item-info">
                                <div class="item-title">${area.name}</div>
                                <div class="item-meta">
                                    ${area.billable ? 'üí∞ Billable' : 'üìã Non-billable'} ‚Ä¢
                                    ${area.tasks?.length || 0} tasks
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-sm btn-edit" onclick="editArea('${area.id}')">Edit</button>
                                <button class="btn-sm btn-delete" onclick="deleteArea('${area.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('management-content').innerHTML = html;
        }

        async function addArea() {
            const name = document.getElementById('new-area-name').value.trim();
            const billable = document.getElementById('new-area-billable').value === 'true';

            if (!name) {
                alert('Please enter area name');
                return;
            }

            if (!managementProject.areas) managementProject.areas = [];

            const newArea = {
                id: Date.now().toString(),
                name: name,
                billable: billable,
                tasks: [],
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };

            managementProject.areas.push(newArea);

            // üî• REAL-TIME: Write area creation directly to Firebase
            if (firebaseOps) {
                console.log('üî• Manager: Creating area in Firebase - Hub & Worker will see this instantly!');
                // Update project with new area
                const stateUpdate = await firebaseOps.getHubState();
                if (stateUpdate && stateUpdate.projects) {
                    const projectIndex = stateUpdate.projects.findIndex(p => p.id === managementProject.id);
                    if (projectIndex !== -1) {
                        stateUpdate.projects[projectIndex] = managementProject;

                        // Write back to Firebase
                        try {
                            const docRef = window.firestore.doc(window.db, 'hubs', 'main');
                            await window.firestore.setDoc(docRef, {
                                ...stateUpdate,
                                lastModified: new Date().toISOString(),
                                lastSyncedBy: currentUser.name
                            });

                            // Log activity
                            await firebaseOps.logActivity('AREA_CREATED',
                                `Manager created area: ${name} in ${managementProject.name}`,
                                {
                                    projectId: managementProject.id,
                                    projectName: managementProject.name,
                                    areaId: newArea.id,
                                    areaName: name,
                                    billable: billable
                                }
                            );

                            console.log('‚úÖ Manager: Area synced to Firebase in real-time!');
                            showToast('Area added - synced across all apps!', 'success');
                        } catch (error) {
                            console.error('‚ùå Firebase write failed:', error);
                            showToast('Area saved locally - will sync when connection restored', 'warning');
                        }
                    }
                }
            } else {
                // Fallback to localStorage
                logActivity('AREA_CREATED', `Created area: ${name}`);
                showToast('Area added!', 'success');
            }

            // ALWAYS save to localStorage as backup (even when Firebase is enabled)
            await saveHubState('projects');

            // Log activity locally
            logActivity('AREA_CREATED', `Created area: ${name}`);

            closeModal('add-area-modal');
            showManageAreas();

            console.log('‚úÖ Manager: Area added to local state and UI refreshed');
        }

        async function deleteArea(areaId) {
            if (!confirm('Delete this area and all its tasks?')) return;

            managementProject.areas = managementProject.areas.filter(a => a.id !== areaId);

            await saveHubState('projects');
            showManageAreas();
            showToast('Area deleted', 'success');
        }

        // ===== MANAGE TASKS =====
        function showManageTasks() {
            if (!managementProject) {
                showToast('Please select a project first', 'warning');
                return;
            }

            currentManagementView = 'tasks';

            // Populate area selector in add task modal
            const areaSelect = document.getElementById('task-area-select');
            areaSelect.innerHTML = '<option value="">-- Choose Area --</option>';

            const areas = managementProject.areas || [];
            areas.forEach(area => {
                areaSelect.innerHTML += `<option value="${area.id}">${area.name}</option>`;
            });

            // Populate assignee selector
            const assigneeSelect = document.getElementById('task-assignee-select');
            assigneeSelect.innerHTML = '<option value="">-- Select Worker --</option>';

            const allUsers = [...(hubState.ourTeam || []), ...(hubState.clientTeam || [])];
            allUsers.forEach(user => {
                assigneeSelect.innerHTML += `<option value="${user.name}">${user.name}</option>`;
            });

            let html = `
                <div class="section-header">Tasks for ${managementProject.name}</div>
                <button class="big-btn primary" onclick="openModal('add-task-modal')">
                    ‚ûï Add New Task
                </button>
            `;

            let allTasks = [];
            areas.forEach(area => {
                if (area.tasks) {
                    area.tasks.forEach(task => {
                        allTasks.push({ ...task, areaName: area.name, areaId: area.id });
                    });
                }
            });

            if (allTasks.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">üìã</div><div>No tasks yet</div></div>`;
            } else {
                allTasks.forEach(task => {
                    const priorityIcon = task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : 'üü¢';
                    const statusBadge = task.completed ? '‚úÖ Done' : task.status === 'progress' ? 'üîÑ In Progress' : '‚è≥ Pending';

                    // Display assignee(s) - handle both single and multi-assignment
                    let assigneeName = 'Unassigned';
                    if (task.assignees && task.assignees.length > 0) {
                        assigneeName = task.assignees.join(', ');
                    } else if (task.assignee) {
                        assigneeName = task.assignee;
                    }

                    // Unread count will be handled by real-time chat system
                    // For now, just show chat button without badge
                    const chatBadge = '';

                    html += `
                        <div class="list-item">
                            <div class="item-info">
                                <div class="item-title">${priorityIcon} ${task.name}</div>
                                <div class="item-meta">
                                    ${task.areaName} ‚Ä¢ ${statusBadge} ‚Ä¢ Assigned to: ${assigneeName}
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-sm btn-chat" onclick="openTaskChat('${task.areaId}', '${task.wbs}')">
                                    üí¨${chatBadge}
                                </button>
                                <button class="btn-sm btn-edit" onclick="editTask('${task.areaId}', '${task.wbs}')">Edit</button>
                                <button class="btn-sm btn-delete" onclick="deleteTask('${task.areaId}', '${task.wbs}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('management-content').innerHTML = html;
        }

        async function addTask() {
            const areaId = document.getElementById('task-area-select').value;
            const name = document.getElementById('new-task-name').value.trim();
            const assignee = document.getElementById('task-assignee-select').value;
            const priority = document.getElementById('task-priority').value;

            if (!areaId || !name) {
                alert('Please fill in all required fields');
                return;
            }

            const area = managementProject.areas.find(a => a.id == areaId);
            if (!area) return;

            if (!area.tasks) area.tasks = [];

            // Generate WBS number
            const wbs = `${managementProject.code || 'T'}.${area.id.slice(-3)}.${area.tasks.length + 1}`;

            // Create task with hub-compatible structure
            const newTask = {
                id: Date.now(),
                wbs: wbs,
                name: name,
                assignee: assignee,
                priority: priority,
                description: '',
                status: 'todo',  // Hub uses 'todo', not 'pending'
                completed: false,
                children: [],  // Hub expects children array
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };

            area.tasks.push(newTask);

            // üî• REAL-TIME: Write task creation directly to Firebase
            if (firebaseOps) {
                console.log('üî• Manager: Creating task in Firebase - Hub & Worker will see this instantly!');
                // Update project with new task
                const stateUpdate = await firebaseOps.getHubState();
                if (stateUpdate && stateUpdate.projects) {
                    const projectIndex = stateUpdate.projects.findIndex(p => p.id === managementProject.id);
                    if (projectIndex !== -1) {
                        stateUpdate.projects[projectIndex] = managementProject;

                        // Write back to Firebase
                        try {
                            const docRef = window.firestore.doc(window.db, 'hubs', 'main');
                            await window.firestore.setDoc(docRef, {
                                ...stateUpdate,
                                lastModified: new Date().toISOString(),
                                lastSyncedBy: currentUser.name
                            });

                            // Log activity
                            await firebaseOps.logActivity('TASK_CREATED',
                                `Manager created task: ${name} ‚Üí ${assignee}`,
                                {
                                    projectId: managementProject.id,
                                    projectName: managementProject.name,
                                    areaId: area.id,
                                    areaName: area.name,
                                    taskWbs: wbs,
                                    taskName: name,
                                    assignee: assignee,
                                    priority: priority
                                }
                            );

                            console.log('‚úÖ Manager: Task synced to Firebase in real-time!');
                            showToast('Task added - synced across all apps!', 'success');
                        } catch (error) {
                            console.error('‚ùå Firebase write failed:', error);
                            showToast('Task saved locally - will sync when connection restored', 'warning');
                        }
                    }
                }
            } else {
                // Fallback to localStorage
                logActivity('TASK_CREATED', `Created task: ${name}`, {
                    assignee: assignee,
                    priority: priority,
                    taskName: name
                });
                await saveHubState('projects');
                showToast('Task added!', 'success');
            }

            closeModal('add-task-modal');
            showManageTasks();
        }

        async function deleteTask(areaId, taskWbs) {
            if (!confirm('Delete this task?')) return;

            const area = managementProject.areas.find(a => a.id == areaId);
            if (area && area.tasks) {
                area.tasks = area.tasks.filter(t => t.wbs !== taskWbs);
            }

            await saveHubState('projects');
            showManageTasks();
            showToast('Task deleted', 'success');
        }

        // ===== MANAGE TOOLS =====
        function showManageTools() {
            currentManagementView = 'tools';
            let html = `
                <div class="section-header">Tools Management</div>
                <button class="big-btn primary" onclick="openModal('add-tool-modal')">
                    ‚ûï Add New Tool
                </button>
            `;

            const tools = hubState.tools || [];

            if (tools.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">üîß</div><div>No tools yet</div></div>`;
            } else {
                tools.forEach(tool => {
                    const statusBadge = tool.status === 'available' ? '‚úÖ Available' : `üîí Checked out to ${tool.checkedOutBy}`;

                    html += `
                        <div class="list-item">
                            <div class="item-info">
                                <div class="item-title">${tool.name}</div>
                                <div class="item-meta">
                                    Serial: ${tool.serial} ‚Ä¢ ${statusBadge}
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-sm btn-edit" onclick="editTool('${tool.id}')">Edit</button>
                                <button class="btn-sm btn-delete" onclick="deleteTool('${tool.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('management-content').innerHTML = html;
        }

        async function addTool() {
            const name = document.getElementById('new-tool-name').value.trim();
            const serial = document.getElementById('new-tool-serial').value.trim();

            if (!name || !serial) {
                alert('Please fill in all fields');
                return;
            }

            if (!hubState.tools) hubState.tools = [];

            const newTool = {
                id: Date.now().toString(),
                name: name,
                serial: serial,
                status: 'available',
                createdAt: new Date().toISOString()
            };

            hubState.tools.push(newTool);

            logActivity('TOOL_CREATED', `Added tool: ${name}`);
            await saveHubState('tools');

            closeModal('add-tool-modal');
            showManageTools();
            showToast('Tool added!', 'success');
        }

        async function deleteTool(toolId) {
            if (!confirm('Delete this tool?')) return;

            hubState.tools = hubState.tools.filter(t => t.id !== toolId);

            await saveHubState('tools');
            showManageTools();
            showToast('Tool deleted', 'success');
        }

        // ===== MANAGE USERS =====
        function showManageUsers() {
            currentManagementView = 'users';
            let html = `
                <div class="section-header">Users Management</div>
                <button class="big-btn primary" onclick="openModal('add-user-modal')">
                    ‚ûï Add New User
                </button>
            `;

            const allUsers = [...(hubState.ourTeam || []), ...(hubState.clientTeam || [])];

            if (allUsers.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">üë•</div><div>No users yet</div></div>`;
            } else {
                allUsers.forEach(user => {
                    const roleBadge = user.accessLevel === 'Admin' ? 'üëë Admin' :
                                     user.accessLevel === 'Manager' ? '‚öôÔ∏è Manager' : 'üë∑ Worker';

                    html += `
                        <div class="list-item">
                            <div class="item-info">
                                <div class="item-title">${user.name}</div>
                                <div class="item-meta">
                                    ${roleBadge} ‚Ä¢ PIN: ${user.pin}
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-sm btn-edit" onclick="editUser('${user.id}')">Edit</button>
                                <button class="btn-sm btn-delete" onclick="deleteUser('${user.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('management-content').innerHTML = html;
        }

        async function addUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const pin = document.getElementById('new-user-pin').value.trim();
            const accessLevel = document.getElementById('new-user-access').value;

            if (!name || !pin) {
                alert('Please fill in all fields');
                return;
            }

            if (pin.length !== 4) {
                alert('PIN must be 4 digits');
                return;
            }

            if (!hubState.ourTeam) hubState.ourTeam = [];

            const newUser = {
                id: Date.now().toString(),
                name: name,
                pin: pin,
                accessLevel: accessLevel,
                createdAt: new Date().toISOString()
            };

            hubState.ourTeam.push(newUser);

            logActivity('USER_CREATED', `Added user: ${name}`);
            await saveHubState('users');

            closeModal('add-user-modal');
            showManageUsers();
            showToast('User added!', 'success');
        }

        async function deleteUser(userId) {
            if (!confirm('Delete this user?')) return;

            hubState.ourTeam = (hubState.ourTeam || []).filter(u => u.id !== userId);
            hubState.clientTeam = (hubState.clientTeam || []).filter(u => u.id !== userId);

            await saveHubState('users');
            showManageUsers();
            showToast('User deleted', 'success');
        }

        // ===== EDIT FUNCTIONS =====
        function editTask(areaId, taskWbs) {
            const area = managementProject.areas.find(a => a.id == areaId);
            if (!area) return;

            const task = area.tasks.find(t => t.wbs == taskWbs);
            if (!task) return;

            // Store editing context
            editingTaskAreaId = areaId;
            editingTaskWbs = taskWbs;

            // Populate edit form
            document.getElementById('edit-task-name').value = task.name;
            document.getElementById('edit-task-priority').value = task.priority;

            // Populate assignees with checkboxes
            const assigneesContainer = document.getElementById('edit-task-assignees');
            const allUsers = [...(hubState.ourTeam || []), ...(hubState.clientTeam || [])];

            // Convert old single assignee to array format if needed
            if (task.assignee && typeof task.assignee === 'string' && !task.assignees) {
                task.assignees = task.assignee.split(',').map(a => a.trim());
            }
            const taskAssignees = task.assignees || [];

            if (allUsers.length === 0) {
                assigneesContainer.innerHTML = '<p style="color: var(--text-tertiary); font-size: 13px; margin: 0;">No team members available.</p>';
            } else {
                assigneesContainer.innerHTML = allUsers.map(user => `
                    <div class="checkbox-group" style="margin-bottom: 8px;">
                        <input type="checkbox" id="edit-assignee-${user.id}" value="${user.name}" ${taskAssignees.includes(user.name) ? 'checked' : ''}>
                        <label for="edit-assignee-${user.id}" style="font-size: 14px;">${user.name}</label>
                    </div>
                `).join('');
            }

            openModal('edit-task-modal');
        }

        async function updateTask() {
            if (!editingTaskAreaId || !editingTaskWbs) return;

            const area = managementProject.areas.find(a => a.id == editingTaskAreaId);
            if (!area) return;

            const task = area.tasks.find(t => t.wbs == editingTaskWbs);
            if (!task) return;

            const name = document.getElementById('edit-task-name').value.trim();
            const priority = document.getElementById('edit-task-priority').value;

            // Collect selected assignees from checkboxes
            const assigneesContainer = document.getElementById('edit-task-assignees');
            const checkedBoxes = assigneesContainer.querySelectorAll('input[type="checkbox"]:checked');
            const assignees = Array.from(checkedBoxes).map(cb => cb.value);

            if (!name) {
                alert('Please enter task name');
                return;
            }

            task.name = name;
            task.assignees = assignees;
            task.assignee = assignees.length > 0 ? assignees.join(', ') : '';
            task.priority = priority;

            logActivity('TASK_UPDATED', `Updated task: ${name}`, {
                assignee: task.assignee,
                priority: priority,
                taskName: name
            });
            await saveHubState('projects');

            editingTaskAreaId = null;
            editingTaskWbs = null;

            closeModal('edit-task-modal');
            showManageTasks();
            showToast('Task updated!', 'success');
        }

        function editArea(areaId) {
            const area = managementProject.areas.find(a => a.id == areaId);
            if (!area) return;

            editingAreaId = areaId;

            document.getElementById('edit-area-name').value = area.name;
            document.getElementById('edit-area-billable').value = area.billable ? 'true' : 'false';

            openModal('edit-area-modal');
        }

        async function updateArea() {
            if (!editingAreaId) return;

            const area = managementProject.areas.find(a => a.id == editingAreaId);
            if (!area) return;

            const name = document.getElementById('edit-area-name').value.trim();
            const billable = document.getElementById('edit-area-billable').value === 'true';

            if (!name) {
                alert('Please enter area name');
                return;
            }

            area.name = name;
            area.billable = billable;

            logActivity('AREA_UPDATED', `Updated area: ${name}`);
            await saveHubState('projects');

            editingAreaId = null;

            closeModal('edit-area-modal');
            showManageAreas();
            showToast('Area updated!', 'success');
        }

        function editTool(toolId) {
            const tool = hubState.tools.find(t => t.id == toolId);
            if (!tool) return;

            editingToolId = toolId;

            document.getElementById('edit-tool-name').value = tool.name;
            document.getElementById('edit-tool-serial').value = tool.serial;

            openModal('edit-tool-modal');
        }

        async function updateTool() {
            if (!editingToolId) return;

            const tool = hubState.tools.find(t => t.id == editingToolId);
            if (!tool) return;

            const name = document.getElementById('edit-tool-name').value.trim();
            const serial = document.getElementById('edit-tool-serial').value.trim();

            if (!name || !serial) {
                alert('Please fill in all fields');
                return;
            }

            tool.name = name;
            tool.serial = serial;

            logActivity('TOOL_UPDATED', `Updated tool: ${name}`);
            await saveHubState('tools');

            editingToolId = null;

            closeModal('edit-tool-modal');
            showManageTools();
            showToast('Tool updated!', 'success');
        }

        function editUser(userId) {
            const allUsers = [...(hubState.ourTeam || []), ...(hubState.clientTeam || [])];
            const user = allUsers.find(u => u.id == userId);
            if (!user) return;

            editingUserId = userId;

            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-pin').value = user.pin;
            document.getElementById('edit-user-access').value = user.accessLevel;

            openModal('edit-user-modal');
        }

        async function updateUser() {
            if (!editingUserId) return;

            let user = hubState.ourTeam?.find(u => u.id == editingUserId);
            if (!user) {
                user = hubState.clientTeam?.find(u => u.id == editingUserId);
            }
            if (!user) return;

            const name = document.getElementById('edit-user-name').value.trim();
            const pin = document.getElementById('edit-user-pin').value.trim();
            const accessLevel = document.getElementById('edit-user-access').value;

            if (!name || !pin) {
                alert('Please fill in all fields');
                return;
            }

            if (pin.length !== 4) {
                alert('PIN must be 4 digits');
                return;
            }

            user.name = name;
            user.pin = pin;
            user.accessLevel = accessLevel;

            logActivity('USER_UPDATED', `Updated user: ${name}`);
            await saveHubState('users');

            editingUserId = null;

            closeModal('edit-user-modal');
            showManageUsers();
            showToast('User updated!', 'success');
        }

        // ===== UTILITY FUNCTIONS =====
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = type === 'success' ? '‚úì' : type === 'warning' ? '‚ö†' : '‚Ñπ';
            toast.innerHTML = `
                <span style="font-size: 20px;">${icon}</span>
                <span>${message}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function logActivity(type, message, details = {}) {
            if (!hubState.activities) hubState.activities = [];

            hubState.activities.push({
                id: Date.now().toString(),
                type: type,
                userId: currentUser.id,
                userName: currentUser.name,
                projectId: selectedProject ? selectedProject.id : (managementProject ? managementProject.id : null),
                message: message,
                details: details,
                timestamp: new Date().toISOString(),
                source: 'manager'
            });
        }

        function logout() {
            if (clockedInTime) {
                alert('Please clock out before logging out.');
                return;
            }

            localStorage.removeItem('pm_hub_current_user');
            window.location.href = 'index.html';
        }

        // ===== TASK CHAT FUNCTIONS (REAL-TIME) =====
        async function openTaskChat(areaId, taskWbs) {
            if (!chatSystem) {
                console.error('üí¨ Chat system not initialized');
                showToast('Chat system not available', 'error');
                return;
            }

            const area = managementProject.areas.find(a => a.id == areaId);
            if (!area) return;

            const task = area.tasks.find(t => t.wbs == taskWbs);
            if (!task) return;

            // Store current chat task
            currentChatTask = {
                areaId,
                taskWbs,
                task,
                projectId: managementProject.id,
                projectName: managementProject.name,
                areaName: area.name
            };

            // Update chat header
            document.getElementById('chat-task-name').textContent = task.name;
            document.getElementById('chat-task-info').textContent = `${area.name} ‚Ä¢ ${managementProject.name}`;

            // Show modal
            document.getElementById('task-chat-modal').classList.add('active');

            // Initialize chat in Firebase
            await chatSystem.initializeChat(managementProject.id, areaId, taskWbs, task.name);

            // Start real-time listener
            activeChatListener = chatSystem.listenToMessages(
                managementProject.id,
                areaId,
                taskWbs,
                (messages) => {
                    // Store messages for rendering
                    currentChatTask.messages = messages;
                    renderChatMessages(messages);

                    // Mark unread messages as read
                    const unreadMessageIds = messages
                        .filter(msg => !msg.readBy?.includes(currentUser.id) && msg.userId !== currentUser.id)
                        .map(msg => msg.id);

                    if (unreadMessageIds.length > 0) {
                        chatSystem.markMessagesAsRead(managementProject.id, areaId, taskWbs, unreadMessageIds);
                    }
                }
            );

            // Focus input
            setTimeout(() => {
                document.getElementById('chat-input').focus();
            }, 100);

            console.log('üí¨ Manager: Real-time chat opened for task', taskWbs);
        }

        function closeTaskChat() {
            document.getElementById('task-chat-modal').classList.remove('active');

            // Stop real-time listener
            if (activeChatListener) {
                activeChatListener();
                activeChatListener = null;
            }

            currentChatTask = null;
            console.log('üí¨ Manager: Chat closed');
        }

        function renderChatMessages(messages = []) {
            const messagesContainer = document.getElementById('chat-messages');

            if (!messages || messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="chat-empty">
                        <div class="chat-empty-icon">üí¨</div>
                        <div>No messages yet</div>
                        <div style="font-size: 13px; margin-top: 8px;">Start a conversation about this task</div>
                    </div>
                `;
                return;
            }

            let html = '';
            messages.forEach(msg => {
                const isOwn = msg.userId === currentUser.id;

                // Handle timestamp - could be Firebase Timestamp or ISO string
                let time = '';
                if (msg.timestamp) {
                    const date = msg.timestamp.toDate ? msg.timestamp.toDate() : new Date(msg.timestamp);
                    time = date.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit'
                    });
                }

                html += `
                    <div class="chat-message ${isOwn ? 'own' : 'other'}">
                        <div class="chat-message-header">
                            <span class="chat-message-user">${escapeHtml(msg.userName)}</span>
                            <span class="chat-message-time">${time}</span>
                        </div>
                        <div class="chat-message-bubble">
                            ${escapeHtml(msg.text).replace(/\n/g, '<br>')}
                        </div>
                    </div>
                `;
            });

            messagesContainer.innerHTML = html;

            // Auto-scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendChatMessage() {
            if (!chatSystem || !currentChatTask) return;

            const input = document.getElementById('chat-input');
            const text = input.value.trim();

            if (!text) return;

            // Send message via Firebase
            const success = await chatSystem.sendMessage(
                currentChatTask.projectId,
                currentChatTask.areaId,
                currentChatTask.taskWbs,
                text,
                currentChatTask.task.name
            );

            if (success) {
                // Clear input
                input.value = '';

                // Log activity for notifications
                logActivity('TASK_MESSAGE', `New message in: ${currentChatTask.task.name}`, {
                    taskName: currentChatTask.task.name,
                    taskWbs: currentChatTask.taskWbs,
                    message: text.substring(0, 100)
                });

                console.log('üí¨ Manager: Message sent successfully');
            } else {
                showToast('Failed to send message', 'error');
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        async function getUnreadChatCount(projectId, areaId, taskWbs) {
            // This will be handled by the chat system's unread count callback
            // For now, return 0 as the real-time system will update badges automatically
            return 0;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== NOTIFICATION CENTER =====
        let notifications = [];
        let unreadCount = 0;

        function loadNotifications() {
            const saved = localStorage.getItem('manager_notifications');
            if (saved) {
                notifications = JSON.parse(saved);
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function saveNotifications() {
            // Keep last 50 notifications
            if (notifications.length > 50) {
                notifications = notifications.slice(-50);
            }
            localStorage.setItem('manager_notifications', JSON.stringify(notifications));
        }

        function addNotification(activity, userName) {
            // Don't add notification from ourselves
            if (userName === currentUser?.name) return;

            const notification = {
                id: Date.now().toString(),
                type: activity.type,
                user: userName,
                message: activity.message,
                details: activity.details || {},
                timestamp: new Date().toISOString(),
                read: false
            };

            notifications.unshift(notification);
            unreadCount++;

            saveNotifications();
            updateNotificationBadge();
            renderNotifications();
        }

        function updateNotificationBadge() {
            unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');
            if (badge) {
                badge.textContent = unreadCount;
                badge.classList.toggle('hidden', unreadCount === 0);
            }
        }

        function toggleNotificationCenter() {
            const center = document.getElementById('notification-center');
            center.classList.toggle('active');
        }

        function markAllAsRead() {
            notifications.forEach(n => n.read = true);
            unreadCount = 0;
            saveNotifications();
            updateNotificationBadge();
            renderNotifications();
        }

        function markAsRead(notifId) {
            const notif = notifications.find(n => n.id === notifId);
            if (notif && !notif.read) {
                notif.read = true;
                unreadCount = Math.max(0, unreadCount - 1);
                saveNotifications();
                updateNotificationBadge();
                renderNotifications();
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'TASK_START': '‚ñ∂Ô∏è',
                'TASK_COMPLETE': '‚úÖ',
                'TASK_CREATED': 'üìã',
                'TASK_UPDATED': 'üìù',
                'TASK_MESSAGE': 'üí¨',
                'AREA_CREATED': 'üìç',
                'AREA_UPDATED': 'üìç',
                'TOOL_CHECKOUT': 'üîß',
                'TOOL_CHECKIN': '‚úì',
                'USER_CREATED': 'üë§',
                'REPORT': 'üì∏',
                'CLOCK_IN': '‚è∞',
                'CLOCK_OUT': 'üèÅ'
            };
            return icons[type] || '‚ÑπÔ∏è';
        }

        function getRelativeTime(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function renderNotifications() {
            const body = document.getElementById('notif-center-body');
            if (!body) return;

            if (notifications.length === 0) {
                body.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üîî</div>
                        <div>No notifications</div>
                    </div>
                `;
                return;
            }

            let html = '';
            notifications.forEach(notif => {
                const icon = getNotificationIcon(notif.type);
                const time = getRelativeTime(notif.timestamp);
                const unreadClass = notif.read ? '' : 'unread';

                // Build action links for specific notification types
                let actionHtml = '';
                if (notif.type === 'REPORT' && notif.details.driveFileId) {
                    actionHtml = `
                        <div class="notif-item-action">
                            <a href="https://drive.google.com/file/d/${notif.details.driveFileId}/view"
                               target="_blank"
                               class="notif-action-link"
                               onclick="event.stopPropagation()">
                                üìÅ View Report File ‚Üí
                            </a>
                        </div>
                    `;
                } else if (notif.type === 'REPORT' && notif.details.driveFolderId) {
                    actionHtml = `
                        <div class="notif-item-action">
                            <a href="https://drive.google.com/drive/folders/${notif.details.driveFolderId}"
                               target="_blank"
                               class="notif-action-link"
                               onclick="event.stopPropagation()">
                                üìÅ View Reports Folder ‚Üí
                            </a>
                        </div>
                    `;
                }

                html += `
                    <div class="notif-item ${unreadClass}" onclick="markAsRead('${notif.id}')">
                        <div class="notif-item-header">
                            <span class="notif-item-icon">${icon}</span>
                            <span class="notif-item-user">${notif.user}</span>
                            <span class="notif-item-time">${time}</span>
                        </div>
                        <div class="notif-item-message">${notif.message}</div>
                        ${actionHtml}
                    </div>
                `;
            });

            body.innerHTML = html;
        }

        // Close notification center when clicking outside
        document.addEventListener('click', (e) => {
            const center = document.getElementById('notification-center');
            const bell = document.getElementById('notification-bell');

            if (center && bell && center.classList.contains('active')) {
                if (!center.contains(e.target) && !bell.contains(e.target)) {
                    center.classList.remove('active');
                }
            }
        });

        // ===== ACTIVITY LOG FUNCTIONS =====
        function showActivityLog() {
            currentManagementView = 'activity';
            renderActivityLogUI();
        }

        function renderActivityLogUI() {
            if (!hubState.activities) hubState.activities = [];

            let html = `
                <div class="section-header">Activity Log</div>

                <!-- Activity Filters -->
                <div class="activity-header">
                    <div class="activity-filters">
                        <select id="activity-filter-source" onchange="renderManagerActivityFeed()" class="activity-filter-select">
                            <option value="all">All Sources</option>
                            <option value="worker">üì± Worker</option>
                            <option value="manager">‚öôÔ∏è Manager</option>
                            <option value="hub">üñ•Ô∏è Hub</option>
                        </select>
                        <select id="activity-filter-type" onchange="renderManagerActivityFeed()" class="activity-filter-select">
                            <option value="all">All Activities</option>
                            <option value="CLOCK_IN">Clock In/Out</option>
                            <option value="TASK_START">Task Start</option>
                            <option value="TASK_COMPLETE">Task Complete</option>
                            <option value="AREA_COMPLETE">Area Complete</option>
                            <option value="TOOL_CHECKOUT">Tool Checkout</option>
                            <option value="REPORT">Reports</option>
                            <option value="TASK_MESSAGE">Messages</option>
                        </select>
                        <select id="activity-filter-user" onchange="renderManagerActivityFeed()" class="activity-filter-select">
                            <option value="all">All Users</option>
                        </select>
                        <select id="activity-filter-project" onchange="renderManagerActivityFeed()" class="activity-filter-select">
                            <option value="all">All Projects</option>
                        </select>
                        <button class="btn-sm btn-primary" onclick="refreshManagerActivity()" title="Refresh activity feed">üîÑ Refresh</button>
                        <div class="live-indicator">
                            <span class="live-dot"></span>
                            <span>Live updates</span>
                        </div>
                    </div>
                </div>

                <!-- Activity Stats -->
                <div class="activity-stats-grid">
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Total Activities</div>
                        <div class="activity-stat-value" id="activity-total">0</div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Today</div>
                        <div class="activity-stat-value" id="activity-today" style="color: var(--accent-primary);">0</div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Tasks Completed</div>
                        <div class="activity-stat-value" id="activity-tasks-complete" style="color: var(--accent-success);">0</div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="activity-stat-label">Areas Complete</div>
                        <div class="activity-stat-value" id="activity-areas-complete" style="color: var(--accent-warning);">0</div>
                    </div>
                </div>

                <!-- Activity Timeline -->
                <div id="activity-timeline" class="activity-timeline">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div>No activities yet. Worker actions will appear here.</div>
                    </div>
                </div>
            `;

            document.getElementById('management-content').innerHTML = html;
            renderManagerActivityFeed();
        }

        function renderManagerActivityFeed() {
            // UNIFIED ACTIVITY SYSTEM: Merge both old 'activities' and new 'activityLog' arrays
            if (!hubState.activities) hubState.activities = [];
            if (!hubState.activityLog) hubState.activityLog = [];

            // Combine both arrays (Worker/Manager Firebase uses activityLog, Hub uses activities)
            const allActivities = [
                ...hubState.activities,
                ...hubState.activityLog
            ];

            // Remove duplicates based on ID and timestamp
            const uniqueActivities = Array.from(
                new Map(allActivities.map(a => [`${a.id}_${a.timestamp}`, a])).values()
            );

            console.log('üìä Manager Activity Feed: Starting render');
            console.log(`   - ${hubState.activities.length} from activities + ${hubState.activityLog.length} from activityLog = ${uniqueActivities.length} total`);
            if (uniqueActivities.length > 0) {
                console.log('   - Sample activity:', uniqueActivities[0]);
            }

            // Populate filter dropdowns
            populateManagerActivityFilters();

            // Get filter values
            const sourceFilter = document.getElementById('activity-filter-source')?.value || 'all';
            const typeFilter = document.getElementById('activity-filter-type')?.value || 'all';
            const userFilter = document.getElementById('activity-filter-user')?.value || 'all';
            const projectFilter = document.getElementById('activity-filter-project')?.value || 'all';

            console.log('   - Filters:', { sourceFilter, typeFilter, userFilter, projectFilter });

            // Filter activities
            let filtered = uniqueActivities.filter(activity => {
                if (sourceFilter !== 'all' && (activity.source || 'hub') !== sourceFilter) return false;
                if (typeFilter !== 'all' && !activity.type.includes(typeFilter)) return false;
                if (userFilter !== 'all' && activity.userId != userFilter) return false;
                if (projectFilter !== 'all' && activity.projectId != projectFilter) return false;
                return true;
            });

            console.log('   - Filtered activities:', filtered.length);

            // Sort by newest first
            filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Update stats
            updateManagerActivityStats(filtered);

            // Render timeline
            const timeline = document.getElementById('activity-timeline');
            if (!timeline) {
                console.error('‚ùå activity-timeline element not found!');
                return;
            }

            console.log('   - Timeline element found:', !!timeline);

            if (filtered.length === 0) {
                console.log('‚ö†Ô∏è No activities after filtering - showing empty state');
                timeline.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div>No activities match the current filters.</div>
                    </div>
                `;
                return;
            }

            console.log('‚úÖ Rendering', filtered.length, 'activities to timeline');

            timeline.innerHTML = filtered.map(activity => {
                const activityTime = new Date(activity.timestamp);
                const timeAgo = getRelativeTime(activity.timestamp);
                const icon = getNotificationIcon(activity.type);
                const color = getManagerActivityColor(activity.type);

                // Source badge
                const source = activity.source || 'hub';
                let sourceBadge = '';
                if (source === 'worker') {
                    sourceBadge = '<span class="activity-source-badge worker">üì± WORKER</span>';
                } else if (source === 'manager') {
                    sourceBadge = '<span class="activity-source-badge">‚öôÔ∏è MANAGER</span>';
                } else {
                    sourceBadge = '<span class="activity-source-badge">üñ•Ô∏è HUB</span>';
                }

                return `
                    <div class="activity-item" style="border-left: 4px solid ${color};">
                        <div class="activity-item-header">
                            <div class="activity-item-content">
                                <span class="activity-icon">${icon}</span>
                                <div>
                                    <div>
                                        <span class="activity-user">${activity.userName || 'Unknown User'}</span>
                                        ${sourceBadge}
                                    </div>
                                    <div class="activity-message">${activity.message}</div>
                                </div>
                            </div>
                            <div class="activity-time">
                                <div class="activity-time-ago">${timeAgo}</div>
                                <div class="activity-timestamp">${activityTime.toLocaleTimeString()}</div>
                            </div>
                        </div>
                        ${activity.projectName ? `<div class="activity-project">üìÅ ${activity.projectName}</div>` : ''}
                        ${activity.details && Object.keys(activity.details).length > 0 ? renderManagerActivityDetails(activity.details) : ''}
                    </div>
                `;
            }).join('');
        }

        function populateManagerActivityFilters() {
            // Combine both activity arrays for filter population
            const allActivities = [
                ...(hubState.activities || []),
                ...(hubState.activityLog || [])
            ];

            // Populate user filter
            const userFilter = document.getElementById('activity-filter-user');
            if (!userFilter) return;

            const users = new Set();
            allActivities.forEach(a => {
                if (a.userId) users.add(JSON.stringify({ id: a.userId, name: a.userName }));
            });

            const currentUserValue = userFilter.value;
            userFilter.innerHTML = '<option value="all">All Users</option>';
            [...users].map(u => JSON.parse(u)).forEach(user => {
                userFilter.innerHTML += `<option value="${user.id}">${user.name}</option>`;
            });
            userFilter.value = currentUserValue;

            // Populate project filter
            const projectFilter = document.getElementById('activity-filter-project');
            if (!projectFilter) return;

            const currentProjectValue = projectFilter.value;
            projectFilter.innerHTML = '<option value="all">All Projects</option>';
            (hubState.projects || []).forEach(project => {
                projectFilter.innerHTML += `<option value="${project.id}">${project.name}</option>`;
            });
            projectFilter.value = currentProjectValue;
        }

        function updateManagerActivityStats(filtered) {
            // Combine both arrays for stats
            const allActivities = [
                ...(hubState.activities || []),
                ...(hubState.activityLog || [])
            ];

            const total = allActivities.length;
            const today = filtered.filter(a => {
                const activityDate = new Date(a.timestamp).toDateString();
                const todayDate = new Date().toDateString();
                return activityDate === todayDate;
            }).length;
            const tasksComplete = allActivities.filter(a => a.type === 'TASK_COMPLETE' || a.type === 'TASK_COMPLETE_DETAILED').length;
            const areasComplete = allActivities.filter(a => a.type === 'AREA_COMPLETE').length;

            const totalEl = document.getElementById('activity-total');
            const todayEl = document.getElementById('activity-today');
            const tasksEl = document.getElementById('activity-tasks-complete');
            const areasEl = document.getElementById('activity-areas-complete');

            if (totalEl) totalEl.textContent = total;
            if (todayEl) todayEl.textContent = today;
            if (tasksEl) tasksEl.textContent = tasksComplete;
            if (areasEl) areasEl.textContent = areasComplete;
        }

        function renderManagerActivityDetails(details) {
            let html = '<div class="activity-details">';
            if (details.billable !== undefined) {
                html += `<div style="color: ${details.billable ? 'var(--accent-success)' : 'var(--text-tertiary)'};">
                    ${details.billable ? 'üí∞ Billable' : 'üìù Non-billable'}
                </div>`;
            }
            if (details.hours) {
                html += `<div style="color: var(--text-secondary);">‚è±Ô∏è ${details.hours} hours</div>`;
            }
            if (details.requiresInvoice) {
                html += `<div style="color: var(--accent-warning); font-weight: 600;">üîî Ready to Invoice</div>`;
            }
            if (details.areaName) {
                html += `<div style="color: var(--text-secondary);">üìÇ ${details.areaName}</div>`;
            }
            if (details.taskName) {
                html += `<div style="color: var(--text-secondary);">‚úì ${details.taskName}</div>`;
            }
            if (details.mediaCount) {
                html += `<div style="color: var(--text-secondary);">üì∏ ${details.uploadedCount || details.mediaCount}/${details.mediaCount} files uploaded</div>`;
            }
            if (details.reportsFolderId) {
                html += `<div style="margin-top: 8px;">
                    <a href="https://drive.google.com/drive/folders/${details.reportsFolderId}"
                       target="_blank"
                       style="color: var(--accent-primary); text-decoration: none; font-size: 12px;"
                       onclick="event.stopPropagation()">
                        üìÅ View Reports Folder ‚Üí
                    </a>
                </div>`;
            }
            html += '</div>';
            return html;
        }

        function getManagerActivityColor(type) {
            const colors = {
                'CLOCK_IN': 'var(--accent-success)',
                'CLOCK_OUT': 'var(--accent-danger)',
                'TASK_START': 'var(--accent-primary)',
                'TASK_COMPLETE': 'var(--accent-success)',
                'TASK_MESSAGE': 'var(--accent-secondary)',
                'AREA_COMPLETE': 'var(--accent-warning)',
                'TOOL_CHECKOUT': 'var(--accent-primary)',
                'TOOL_CHECKIN': 'var(--accent-success)',
                'REPORT': 'var(--accent-secondary)',
                'INVOICE_CREATE': 'var(--accent-warning)'
            };
            return colors[type] || 'var(--glass-border)';
        }

        function refreshManagerActivity() {
            if (currentManagementView === 'activity') {
                renderManagerActivityFeed();
                showToast('Activity log refreshed', 'success');
            }
        }

        // ===== CALENDAR EVENT FUNCTIONS =====
        function openEventModal() {
            // Populate attendees from teams
            const ourTeamOptgroup = document.getElementById('event-our-team');
            const clientTeamOptgroup = document.getElementById('event-client-team');

            if (ourTeamOptgroup && hubState.ourTeam) {
                ourTeamOptgroup.innerHTML = '';
                hubState.ourTeam.forEach(member => {
                    if (member.email) {
                        ourTeamOptgroup.innerHTML += `<option value="${member.email}">${member.name}</option>`;
                    }
                });
            }

            if (clientTeamOptgroup && hubState.clientTeam) {
                clientTeamOptgroup.innerHTML = '';
                hubState.clientTeam.forEach(member => {
                    if (member.email) {
                        clientTeamOptgroup.innerHTML += `<option value="${member.email}">${member.name}</option>`;
                    }
                });
            }

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('event-date').value = today;

            openModal('event-modal');
        }

        async function createCalendarEvent() {
            const title = document.getElementById('event-title').value.trim();
            const eventDate = document.getElementById('event-date').value;
            const startTime = document.getElementById('event-start-time').value;
            const endTime = document.getElementById('event-end-time').value;
            const description = document.getElementById('event-description').value.trim();

            // Validation
            if (!title) {
                showToast('Please enter event title', 'warning');
                return;
            }

            if (!eventDate) {
                showToast('Please select event date', 'warning');
                return;
            }

            if (!startTime || !endTime) {
                showToast('Please select start and end time', 'warning');
                return;
            }

            if (!window.gapi || !window.gapi.client) {
                showToast('Google Calendar not connected - check Hub settings', 'error');
                return;
            }

            try {
                // Get selected attendees
                const attendees = Array.from(document.getElementById('event-attendees').selectedOptions)
                    .map(o => ({ email: o.value }))
                    .filter(a => a.email);

                const startDateTime = `${eventDate}T${startTime}:00`;
                const endDateTime = `${eventDate}T${endTime}:00`;
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                console.log('üî• Manager: Creating calendar event:', {
                    title,
                    startDateTime,
                    endDateTime,
                    attendees: attendees.length
                });

                const event = {
                    summary: title,
                    description: description || `Event created by Manager: ${currentUser.name}`,
                    start: {
                        dateTime: startDateTime,
                        timeZone: timeZone
                    },
                    end: {
                        dateTime: endDateTime,
                        timeZone: timeZone
                    },
                    attendees: attendees.length > 0 ? attendees : undefined,
                    reminders: {
                        useDefault: false,
                        overrides: [{ method: 'popup', minutes: 30 }]
                    }
                };

                const response = await window.gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event,
                    sendNotifications: attendees.length > 0
                });

                console.log('‚úÖ Manager: Calendar event created:', response.result.id);

                // Log activity to Firebase
                if (firebaseOps) {
                    await firebaseOps.logActivity('EVENT_CREATED',
                        `Manager created event: ${title} (${attendees.length} attendees)`,
                        {
                            eventId: response.result.id,
                            title: title,
                            date: eventDate,
                            startTime: startTime,
                            endTime: endTime,
                            attendeesCount: attendees.length,
                            htmlLink: response.result.htmlLink
                        }
                    );
                }

                closeModal('event-modal');
                showToast(`Event created${attendees.length > 0 ? ' and invitations sent' : ''}!`, 'success');

                // Clear form
                document.getElementById('event-title').value = '';
                document.getElementById('event-description').value = '';
                document.getElementById('event-attendees').selectedIndex = -1;

            } catch (error) {
                console.error('‚ùå Manager: Error creating event:', error);
                showToast('Failed to create event: ' + (error.result?.error?.message || error.message), 'error');
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Real-Time Sync & Notifications -->
    <script src="pm-hub-realtime.js"></script>
    <script>
        // Initialize real-time sync after page load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (currentUser && window.PMHubRealtimeSync) {
                    window.pmRealtime = new PMHubRealtimeSync({
                        appName: 'Manager',
                        currentUser: currentUser,
                        onStateUpdate: (newState, update) => {
                            console.log('üîÑ Manager: State update received', update);

                            // Update local state
                            hubState = newState;

                            // Add notification if there's activity info
                            if (update.activity && update.syncedBy) {
                                addNotification(update.activity, update.syncedBy);
                            }

                            // WORK MODE: Refresh worker-style views
                            if (currentMode === 'work' && selectedProject) {
                                selectedProject = hubState.projects?.find(p => p.id == selectedProject.id);

                                // If on task selection screen, refresh task dropdown
                                const taskSelectionScreen = document.getElementById('task-selection-screen');
                                if (taskSelectionScreen && !taskSelectionScreen.classList.contains('hidden')) {
                                    const areaSelect = document.getElementById('area-select');
                                    if (areaSelect && areaSelect.value) {
                                        loadTasksForArea(); // Refresh task list
                                        console.log('üîÑ Manager (Work): Task list refreshed');
                                    }
                                }

                                // If working on a task, update currentTask with latest data
                                if (currentTask) {
                                    const project = hubState.projects?.find(p => p.id == currentTask.projectId);
                                    if (project) {
                                        const area = project.areas?.find(a => a.id == currentTask.areaId);
                                        if (area) {
                                            const task = area.tasks?.find(t => t.wbs == currentTask.wbs);
                                            if (task) {
                                                currentTask = {
                                                    ...task,
                                                    projectId: project.id,
                                                    projectName: project.name,
                                                    areaId: area.id,
                                                    areaName: area.name
                                                };
                                                console.log('‚úÖ Manager (Work): Current task updated');
                                            }
                                        }
                                    }
                                }
                            }

                            // MANAGE MODE: Refresh management views
                            if (currentMode === 'manage' && managementProject) {
                                managementProject = hubState.projects?.find(p => p.id == managementProject.id);

                                // Refresh the entire management view to update all linked data
                                loadManagementProject();
                                console.log('üîÑ Manager (Manage): Project view refreshed');

                                // If activity log is open, refresh it
                                if (currentManagementView === 'activity') {
                                    renderManagerActivityFeed();
                                    console.log('üìä Manager: Activity log refreshed');
                                }

                                // If team view is open, refresh team display
                                if (currentManagementView === 'team') {
                                    renderManagerTeam();
                                    console.log('üë• Manager: Team view refreshed');
                                }

                                // Chat messages are now handled by real-time Firebase listeners
                                // No manual refresh needed
                            }

                            console.log('‚úÖ Manager: All views refreshed');
                        }
                    });
                    console.log('‚úì Manager: Real-time sync initialized');
                }
            }, 1000); // Wait for init() to complete
        });
    </script>
</body>
</html>
