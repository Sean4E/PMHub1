<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Management System</title>
    <link rel="stylesheet" href="../pm-hub-styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
		  apiKey: "AIzaSyDnwDzHtjFKaWY-VwIMJtomfunkp7t9GFc",
		  authDomain: "assettracker1-5b976.firebaseapp.com",
		  projectId: "assettracker1-5b976",
		  storageBucket: "assettracker1-5b976.firebasestorage.app",
		  messagingSenderId: "260186083597",
		  appId: "1:260186083597:web:5ec0eb9d5f8a4132022044"
		};

        let app, db;
        let isFirebaseReady = false;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isFirebaseReady = true;
            console.log('Firebase initialized successfully');
            updateConnectionStatus(true);
            window.db = db;
            window.firestore = { collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, serverTimestamp };
            window.isFirebaseReady = true;
            if (window.initializeAppData) {
                window.initializeAppData();
            }
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            updateConnectionStatus(false, error.message);
            window.showNotification('Firebase connection failed. Using local storage.', 'error');
            window.isFirebaseReady = false;
        }

        function updateConnectionStatus(connected, message = '') {
            setTimeout(() => {
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                if (dot && text) {
                    if (connected) {
                        dot.className = 'status-dot connected';
                        text.textContent = 'Firebase Connected';
                    } else {
                        dot.className = 'status-dot disconnected';
                        text.textContent = message || 'Local Storage';
                    }
                }
            }, 100);
        }

        window.updateConnectionStatus = updateConnectionStatus;
    </script>
    
    <style id="base-styles">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors - Primary Palette */
            --primary-color: #2c3e50;
            --primary-light: #34495e;
            --primary-dark: #1a252f;
            --secondary-color: #3498db;
            --secondary-light: #5dade2;
            --secondary-dark: #2874a6;
            --accent-color: #e74c3c;
            --accent-light: #ec7063;
            --accent-dark: #c0392b;
            
            /* Colors - Status */
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            
            /* Colors - Backgrounds */
            --bg-primary: #ecf0f1;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --bg-overlay: rgba(0, 0, 0, 0.5);
            
            /* Colors - Text */
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-light: #95a5a6;
            --text-inverse: #ffffff;
            
            /* Colors - Borders */
            --border-color: #bdc3c7;
            --border-light: #ecf0f1;
            --border-dark: #95a5a6;
            
            /* Typography */
            --font-primary: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-secondary: 'Georgia', serif;
            --font-mono: 'Consolas', 'Monaco', monospace;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 24px;
            --font-size-2xl: 32px;
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 700;
            --line-height: 1.6;
            --letter-spacing: 0;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            /* Borders & Radius */
            --border-width: 1px;
            --border-style: solid;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 12px 24px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            
            /* Effects */
            --opacity-disabled: 0.5;
            --opacity-hover: 0.8;
            --blur-sm: 4px;
            --blur-md: 8px;
            --blur-lg: 16px;
            --blur-xl: 24px;
            
            /* Animations */
            --transition-fast: 150ms;
            --transition-base: 250ms;
            --transition-slow: 500ms;
            --easing: cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-blur: 10px;
            
            /* Layout */
            --container-width: 800px;
            --sidebar-width: 480px;
            --header-height: 60px;
        }

        /* Glass Effect Mixin */
        .glass {
            background: var(--glass-bg) !important;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border) !important;
        }

        body {
            font-family: var(--font-primary);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-normal);
            line-height: var(--line-height);
            letter-spacing: var(--letter-spacing);
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: var(--space-md);
            max-width: var(--container-width);
            margin: 0 auto;
            transition: all var(--transition-base) var(--easing);
        }

        .header {
            background: var(--primary-color);
            color: var(--text-inverse);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            text-align: center;
            margin-bottom: var(--space-lg);
            position: relative;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base) var(--easing);
        }

        .header h1 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .section {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
            border: var(--border-width) var(--border-style) var(--border-color);
            transition: all var(--transition-base) var(--easing);
        }

        .hidden {
            display: none !important;
        }

        /* Settings Button */
        .settings-btn {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            color: var(--text-inverse);
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 9998;
            font-size: 24px;
            transition: all var(--transition-base) var(--easing);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: var(--shadow-xl);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100%;
            background: var(--bg-secondary);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            transition: right 0.3s var(--easing);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            background: var(--primary-color);
            color: var(--text-inverse);
            padding: var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-content {
            padding: var(--space-lg);
        }

        .settings-group {
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: var(--border-width) var(--border-style) var(--border-light);
        }

        .settings-group h3 {
            margin-bottom: var(--space-md);
            color: var(--text-primary);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .settings-label {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        /* Color Grid */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .color-input-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .color-input-group label {
            flex: 1;
            font-size: var(--font-size-sm);
            margin: 0;
        }

        .color-input-group input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 2px;
            border-radius: var(--radius-sm);
            cursor: pointer;
        }

        /* Slider Controls */
        .slider-control {
            width: 100%;
            margin-bottom: var(--space-md);
        }

        .slider-control label {
            display: block;
            margin-bottom: var(--space-xs);
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .slider-control input[type="range"] {
            width: 100%;
            margin: var(--space-sm) 0;
        }

        .slider-value {
            text-align: center;
            font-size: var(--font-size-sm);
            color: var(--primary-color);
            font-weight: var(--font-weight-medium);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-color);
            transition: var(--transition-fast);
            border-radius: var(--radius-full);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: var(--transition-fast);
            border-radius: var(--radius-full);
        }

        input:checked + .toggle-slider {
            background: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Preset Grid */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .preset-btn {
            padding: var(--space-md);
            text-align: center;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast) var(--easing);
        }

        .preset-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .preset-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
            border-color: var(--primary-color);
        }

        /* Connection Status */
        .connection-status {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-xs);
            color: var(--text-inverse);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success-color);
        }

        .status-dot.disconnected {
            background: var(--danger-color);
        }

        .status-dot.gps-available {
            background: var(--success-color);
        }

        .status-dot.gps-unavailable {
            background: var(--danger-color);
        }

        .status-dot.gps-loading {
            background: var(--warning-color);
        }

        .status-dot.gps-unknown {
            background: var(--text-light);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Navigation */
        .nav-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            margin-bottom: var(--space-lg);
        }

        button {
            background: var(--secondary-color);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-base);
            font-family: var(--font-primary);
            font-weight: var(--font-weight-medium);
            transition: all var(--transition-fast) var(--easing);
        }

        button:hover {
            opacity: var(--opacity-hover);
            transform: translateY(-1px);
        }

        button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            opacity: var(--opacity-disabled);
        }

        button.admin-btn {
            background: var(--warning-color);
        }

        button.danger-btn {
            background: var(--danger-color);
        }

        button.secondary-btn {
            background: var(--text-secondary);
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--space-md);
        }

        label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: var(--font-weight-medium);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        input, select, textarea {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: var(--font-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast) var(--easing);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .pin-input {
            font-size: var(--font-size-xl);
            text-align: center;
            letter-spacing: 10px;
            max-width: 200px;
            margin: 0 auto;
            font-family: var(--font-mono);
        }

        /* GPS Test */
        .gps-test {
            text-align: center;
            margin: var(--space-md) 0;
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .gps-test-btn {
            background: var(--info-color);
            color: var(--text-inverse);
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--font-size-sm);
        }

        .gps-result {
            margin-top: var(--space-sm);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
        }

        .gps-result.success {
            background: #d4edda;
            color: #155724;
        }

        .gps-result.error {
            background: #f8d7da;
            color: #721c24;
        }

        /* Video Scanner */
        #video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            display: block;
            margin: 0 auto;
        }

        .controls {
            text-align: center;
            margin: var(--space-md) 0;
        }

        .status {
            text-align: center;
            padding: var(--space-md);
            margin: var(--space-sm) 0;
            border-radius: var(--radius-sm);
            font-weight: var(--font-weight-bold);
        }

        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-md);
        }

        th, td {
            border: var(--border-width) var(--border-style) var(--border-color);
            padding: var(--space-sm);
            text-align: left;
        }

        th {
            background: var(--bg-tertiary);
            font-weight: var(--font-weight-bold);
        }

        /* Item Card */
        .item-card {
            background: var(--bg-tertiary);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            margin: var(--space-lg) 0;
            text-align: center;
            border: var(--border-width) var(--border-style) var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .item-status {
            display: inline-block;
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-lg);
            color: var(--text-inverse);
            font-weight: var(--font-weight-bold);
            margin: var(--space-sm) 0;
        }

        .status-available {
            background: var(--success-color);
        }

        .status-checked-out {
            background: var(--warning-color);
        }

        .qr-container {
            text-align: center;
            margin: var(--space-lg) 0;
            padding: var(--space-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            border: 2px dashed var(--border-color);
        }

        .qr-canvas {
            margin: var(--space-sm) auto;
            display: block;
            border: 1px solid var(--border-color);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            justify-content: center;
            margin: var(--space-lg) 0;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            color: var(--text-inverse);
            font-weight: var(--font-weight-bold);
            z-index: 9999;
            max-width: 300px;
            animation: slideIn 0.3s var(--easing);
            box-shadow: var(--shadow-lg);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        /* Firebase Config Notice */
        .firebase-config {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-lg);
        }

        /* Location Prompt */
        .location-prompt {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin: var(--space-md) 0;
            text-align: center;
        }

        .location-instructions {
            text-align: left;
            margin: var(--space-sm) 0;
            padding: var(--space-sm);
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
        }

        /* Editable Dropdown */
        .editable-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-input {
            width: 100%;
            padding: var(--space-sm);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .dropdown-option {
            padding: var(--space-sm);
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
        }

        .dropdown-option:hover {
            background: var(--bg-tertiary);
        }

        .dropdown-option.add-new {
            background: #e3f2fd;
            color: var(--primary-color);
            font-weight: var(--font-weight-bold);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            body {
                padding: var(--space-sm);
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
            
            .pin-input {
                letter-spacing: 5px;
            }

            .connection-status {
                position: static;
                margin: var(--space-sm) auto 0;
                width: fit-content;
            }
            
            .preset-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .color-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Settings Button -->
    <button class="settings-btn" onclick="toggleSettings()" id="settings-toggle-btn">⚙️</button>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2>🎨 Style Builder</h2>
            <button onclick="toggleSettings()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">✕</button>
        </div>
        
        <div class="settings-content">
            <!-- Quick Presets -->
            <div class="settings-group">
                <h3>Quick Themes</h3>
                <div class="preset-grid">
                    <div class="preset-btn" onclick="applyPreset('minimal')">
                        <div>📄</div>
                        <small>Minimal</small>
                    </div>
                    <div class="preset-btn" onclick="applyPreset('glass')">
                        <div>🪟</div>
                        <small>Glass UI</small>
                    </div>
                    <div class="preset-btn" onclick="applyPreset('dark')">
                        <div>🌙</div>
                        <small>Dark</small>
                    </div>
                    <div class="preset-btn" onclick="applyPreset('colorful')">
                        <div>🌈</div>
                        <small>Colorful</small>
                    </div>
                    <div class="preset-btn" onclick="applyPreset('corporate')">
                        <div>💼</div>
                        <small>Corporate</small>
                    </div>
                    <div class="preset-btn" onclick="applyPreset('playful')">
                        <div>🎨</div>
                        <small>Playful</small>
                    </div>
                </div>
            </div>

            <!-- Colors -->
            <div class="settings-group">
                <h3>Colors</h3>
                <div class="color-grid">
                    <div class="color-input-group">
                        <label>Primary</label>
                        <input type="color" id="primary-color" value="#2c3e50" onchange="updateCSS('--primary-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Secondary</label>
                        <input type="color" id="secondary-color" value="#3498db" onchange="updateCSS('--secondary-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Accent</label>
                        <input type="color" id="accent-color" value="#e74c3c" onchange="updateCSS('--accent-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Success</label>
                        <input type="color" id="success-color" value="#27ae60" onchange="updateCSS('--success-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Warning</label>
                        <input type="color" id="warning-color" value="#f39c12" onchange="updateCSS('--warning-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Danger</label>
                        <input type="color" id="danger-color" value="#e74c3c" onchange="updateCSS('--danger-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Info</label>
                        <input type="color" id="info-color" value="#3498db" onchange="updateCSS('--info-color', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Text Primary</label>
                        <input type="color" id="text-primary" value="#2c3e50" onchange="updateCSS('--text-primary', this.value)">
                    </div>
                </div>
            </div>

            <!-- Backgrounds -->
            <div class="settings-group">
                <h3>Backgrounds</h3>
                <div class="color-grid">
                    <div class="color-input-group">
                        <label>Primary BG</label>
                        <input type="color" id="bg-primary" value="#ecf0f1" onchange="updateCSS('--bg-primary', this.value)">
                    </div>
                    <div class="color-input-group">
                        <label>Secondary BG</label>
                        <input type="color" id="bg-secondary" value="#ffffff" onchange="updateCSS('--bg-secondary', this.value)">
                    </div>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Background Style</label>
                    <select onchange="setBackgroundStyle(this.value)" style="width: 150px;">
                        <option value="solid">Solid Color</option>
                        <option value="gradient">Gradient</option>
                        <option value="pattern">Pattern</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Glass Effect</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="glass-toggle" onchange="toggleGlassEffect(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slider-control">
                    <label>Glass Blur</label>
                    <input type="range" min="0" max="30" value="10" oninput="updateCSS('--glass-blur', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>10</span>px</div>
                </div>
            </div>

            <!-- Typography -->
            <div class="settings-group">
                <h3>Typography</h3>
                <div class="settings-row">
                    <label class="settings-label">Primary Font</label>
                    <select onchange="updateCSS('--font-primary', this.value)" style="width: 200px;">
                        <option value="'Segoe UI', system-ui, -apple-system, sans-serif">System UI</option>
                        <option value="'Arial', sans-serif">Arial</option>
                        <option value="'Helvetica Neue', sans-serif">Helvetica</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Times New Roman', serif">Times</option>
                        <option value="'Comic Sans MS', cursive">Comic Sans</option>
                        <option value="'Courier New', monospace">Courier</option>
                    </select>
                </div>
                <div class="slider-control">
                    <label>Base Font Size</label>
                    <input type="range" min="12" max="24" value="16" oninput="updateCSS('--font-size-base', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>16</span>px</div>
                </div>
                <div class="slider-control">
                    <label>Font Weight</label>
                    <input type="range" min="300" max="700" step="100" value="400" oninput="updateCSS('--font-weight-normal', this.value); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>400</span></div>
                </div>
                <div class="slider-control">
                    <label>Line Height</label>
                    <input type="range" min="1" max="2" step="0.1" value="1.6" oninput="updateCSS('--line-height', this.value); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>1.6</span></div>
                </div>
                <div class="slider-control">
                    <label>Letter Spacing</label>
                    <input type="range" min="-2" max="5" value="0" oninput="updateCSS('--letter-spacing', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>0</span>px</div>
                </div>
            </div>

            <!-- Borders & Radius -->
            <div class="settings-group">
                <h3>Borders & Corners</h3>
                <div class="slider-control">
                    <label>Border Width</label>
                    <input type="range" min="0" max="5" value="1" oninput="updateCSS('--border-width', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>1</span>px</div>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Border Style</label>
                    <select onchange="updateCSS('--border-style', this.value)" style="width: 150px;">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                        <option value="double">Double</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="slider-control">
                    <label>Small Radius</label>
                    <input type="range" min="0" max="20" value="4" oninput="updateCSS('--radius-sm', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>4</span>px</div>
                </div>
                <div class="slider-control">
                    <label>Medium Radius</label>
                    <input type="range" min="0" max="30" value="8" oninput="updateCSS('--radius-md', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>8</span>px</div>
                </div>
                <div class="slider-control">
                    <label>Large Radius</label>
                    <input type="range" min="0" max="50" value="16" oninput="updateCSS('--radius-lg', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>16</span>px</div>
                </div>
            </div>

            <!-- Shadows -->
            <div class="settings-group">
                <h3>Shadows & Effects</h3>
                <div class="settings-row">
                    <label class="settings-label">Enable Shadows</label>
                    <label class="toggle-switch">
                        <input type="checkbox" checked onchange="toggleShadows(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slider-control">
                    <label>Shadow Intensity</label>
                    <input type="range" min="0" max="50" value="10" oninput="updateShadowIntensity(this.value); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>10</span></div>
                </div>
                <div class="slider-control">
                    <label>Blur Amount</label>
                    <input type="range" min="0" max="30" value="8" oninput="updateCSS('--blur-md', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>8</span>px</div>
                </div>
            </div>

            <!-- Spacing -->
            <div class="settings-group">
                <h3>Spacing</h3>
                <div class="slider-control">
                    <label>Small Space</label>
                    <input type="range" min="2" max="16" value="8" oninput="updateCSS('--space-sm', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>8</span>px</div>
                </div>
                <div class="slider-control">
                    <label>Medium Space</label>
                    <input type="range" min="8" max="32" value="16" oninput="updateCSS('--space-md', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>16</span>px</div>
                </div>
                <div class="slider-control">
                    <label>Large Space</label>
                    <input type="range" min="16" max="48" value="24" oninput="updateCSS('--space-lg', this.value + 'px'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>24</span>px</div>
                </div>
            </div>

            <!-- Animations -->
            <div class="settings-group">
                <h3>Animations</h3>
                <div class="settings-row">
                    <label class="settings-label">Enable Animations</label>
                    <label class="toggle-switch">
                        <input type="checkbox" checked onchange="toggleAnimations(this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="slider-control">
                    <label>Animation Speed</label>
                    <input type="range" min="0" max="1000" value="250" oninput="updateCSS('--transition-base', this.value + 'ms'); this.nextElementSibling.firstElementChild.textContent = this.value">
                    <div class="slider-value"><span>250</span>ms</div>
                </div>
                <div class="settings-row">
                    <label class="settings-label">Easing Function</label>
                    <select onchange="updateCSS('--easing', this.value)" style="width: 200px;">
                        <option value="cubic-bezier(0.4, 0, 0.2, 1)">Smooth</option>
                        <option value="ease">Ease</option>
                        <option value="ease-in">Ease In</option>
                        <option value="ease-out">Ease Out</option>
                        <option value="ease-in-out">Ease In-Out</option>
                        <option value="linear">Linear</option>
                    </select>
                </div>
            </div>

            <!-- Actions -->
            <div class="settings-group">
                <h3>Actions</h3>
                <div style="display: flex; gap: 10px;">
                    <button onclick="resetStyles()" style="background: var(--danger-color); flex: 1;">Reset All</button>
                    <button onclick="exportStyles()" style="background: var(--primary-color); flex: 1;">Export</button>
                    <button onclick="importStyles()" style="background: var(--secondary-color); flex: 1;">Import</button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport(event)">
            </div>
        </div>
    </div>

    <div class="header">
        <h1>🔧 Tool Management System</h1>
        <p id="user-info">Please sign in</p>
        <div class="connection-status">
            <div class="status-indicator">
                <div id="status-dot" class="status-dot disconnected"></div>
                <span id="status-text">Connecting...</span>
            </div>
            <div class="status-indicator">
                <div id="gps-dot" class="status-dot gps-unknown"></div>
                <span id="gps-text">GPS Unknown</span>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration Notice -->
    <div id="firebase-config-notice" class="firebase-config">
        <h3>🔧 Firebase Setup Required</h3>
        <p><strong>To enable data syncing across devices:</strong></p>
        <ol>
            <li>Create a Firebase project at <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>
            <li>Create a Firestore database</li>
            <li>Get your config from Project Settings</li>
            <li>Replace the firebaseConfig in the HTML source</li>
        </ol>
        <p><em>Currently using local storage only.</em></p>
        <button onclick="hideFirebaseNotice()">Hide This Notice</button>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="section">
        <h2>🔐 Sign In</h2>
        <div class="nav-buttons">
            <button onclick="showUserLogin()">User Login</button>
            <button onclick="showAdminLogin()" class="admin-btn">Admin Login</button>
        </div>

        <!-- GPS Test Section -->
        <div class="gps-test">
            <button class="gps-test-btn" onclick="testGPSOnLogin()">Test GPS</button>
            <div id="gps-test-result" class="gps-result hidden"></div>
        </div>

        <div id="user-login" class="hidden">
            <h3>User Login</h3>
            <div class="form-group">
                <label>Enter your 6-digit PIN:</label>
                <input type="password" id="user-pin" class="pin-input" maxlength="6" placeholder="000000">
            </div>
            <button onclick="loginUser()">Sign In</button>
            <p style="margin-top: 15px; font-size: 14px; color: #666;">
                Demo PINs: 123456 (John Smith), 234567 (Jane Doe), 345678 (Bob Johnson)
            </p>
        </div>

        <div id="admin-login" class="hidden">
            <h3>Admin Login</h3>
            <div class="form-group">
                <label>Admin PIN:</label>
                <input type="password" id="admin-pin" class="pin-input" maxlength="6" placeholder="000000">
            </div>
            <button onclick="loginAdmin()" class="admin-btn">Admin Sign In</button>
            <p style="margin-top: 15px; font-size: 14px; color: #666;">
                Admin PIN: 999999
            </p>
        </div>
    </div>

    <!-- User Section -->
    <div id="user-section" class="section hidden">
        <div class="nav-buttons">
            <button onclick="startScanning()">📱 Scan QR Code</button>
            <button onclick="logout()" class="secondary-btn">Sign Out</button>
        </div>

        <div id="scanner-area" class="hidden">
            <h3>QR Scanner</h3>
            <video id="video" class="hidden"></video>
            <div class="controls">
                <button id="start-scanner-btn" onclick="startScanner()">Start Camera</button>
                <button id="stop-scanner-btn" onclick="stopScanner()" class="danger-btn hidden">Stop Camera</button>
            </div>
            <div id="scanner-status" class="status">Ready to scan</div>
        </div>

        <div id="item-action" class="hidden">
            <!-- Item details and action buttons will be populated here -->
        </div>
    </div>

    <!-- Admin Section -->
    <div id="admin-section" class="section hidden">
        <div class="nav-buttons">
            <button onclick="showUserManagement()">👥 Manage Users</button>
            <button onclick="showItemManagement()">📦 Manage Items</button>
            <button onclick="showActivityLogs()">📋 Activity Logs</button>
            <button onclick="logout()" class="secondary-btn">Sign Out</button>
        </div>

        <!-- User Management -->
        <div id="user-management" class="hidden">
            <h3>User Management</h3>
            <div class="form-group">
                <h4>Add New User</h4>
                <label>User Name:</label>
                <input type="text" id="new-user-name" placeholder="Enter user name">
            </div>
            <div class="form-group">
                <label>6-Digit PIN:</label>
                <input type="text" id="new-user-pin" placeholder="123456" maxlength="6" pattern="[0-9]{6}">
            </div>
            <button onclick="addUser()">Add User</button>

            <div id="users-list">
                <!-- Users will be populated here -->
            </div>
        </div>

        <!-- Item Management -->
        <div id="item-management" class="hidden">
            <h3>Item Management</h3>
            <div class="form-group">
                <h4>Add New Item</h4>
                <label>Item Name *:</label>
                <input type="text" id="new-item-name" placeholder="Enter item name">
            </div>
            <div class="form-group">
                <label>Type/Category *:</label>
                <div class="editable-dropdown">
                    <input type="text" id="new-item-type" class="dropdown-input" placeholder="Select or type new category">
                    <div id="type-dropdown" class="dropdown-options hidden"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Brand *:</label>
                <input type="text" id="new-item-brand" placeholder="Enter brand">
            </div>
            <div class="form-group">
                <label>Model Number *:</label>
                <input type="text" id="new-item-model" placeholder="Enter model number">
            </div>
            <div class="form-group">
                <label>Serial Number:</label>
                <input type="text" id="new-item-serial" placeholder="Enter serial number (optional)">
            </div>
            <div class="form-group">
                <label>Description:</label>
                <textarea id="new-item-description" placeholder="Additional details..." rows="3"></textarea>
            </div>
            <button onclick="addItem()">Add Item & Generate QR</button>

            <div id="items-list">
                <!-- Items will be populated here -->
            </div>
        </div>

        <!-- Activity Logs -->
        <div id="activity-logs" class="hidden">
            <h3>Activity Logs</h3>
            <div id="logs-list">
                <!-- Activity logs will be populated here -->
            </div>
            <button onclick="clearLogs()" class="danger-btn">Clear All Logs</button>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let currentRole = null;
        let qrScanner = null;
        let scanning = false;
        let currentScannedItem = null;

        // Default item types
        const defaultItemTypes = [
            'Power Tool',
            'Hand Tool',
            'Measuring Tool', 
            'Safety Equipment',
            'Hardware',
            'Electronic Tool',
            'Garden Tool',
            'Automotive Tool'
        ];

        // Style Builder Functions
        function updateCSS(property, value) {
            document.documentElement.style.setProperty(property, value);
            saveStyles();
        }

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('open');
        }

        function applyPreset(presetName) {
            const presets = {
                minimal: {
                    '--primary-color': '#000000',
                    '--secondary-color': '#666666',
                    '--bg-primary': '#ffffff',
                    '--bg-secondary': '#f8f8f8',
                    '--text-primary': '#000000',
                    '--border-width': '1px',
                    '--radius-sm': '0px',
                    '--radius-md': '0px',
                    '--radius-lg': '0px',
                    '--shadow-sm': 'none',
                    '--shadow-md': 'none',
                    '--shadow-lg': 'none'
                },
                glass: {
                    '--primary-color': '#667eea',
                    '--secondary-color': '#764ba2',
                    '--bg-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    '--bg-secondary': 'rgba(255, 255, 255, 0.1)',
                    '--glass-bg': 'rgba(255, 255, 255, 0.1)',
                    '--glass-blur': '20px',
                    '--glass-border': 'rgba(255, 255, 255, 0.2)',
                    '--text-primary': '#ffffff',
                    '--border-width': '1px',
                    '--radius-md': '16px',
                    '--shadow-lg': '0 8px 32px rgba(0, 0, 0, 0.3)'
                },
                dark: {
                    '--primary-color': '#bb86fc',
                    '--secondary-color': '#03dac6',
                    '--accent-color': '#cf6679',
                    '--bg-primary': '#121212',
                    '--bg-secondary': '#1e1e1e',
                    '--text-primary': '#ffffff',
                    '--text-secondary': '#b3b3b3',
                    '--border-color': '#333333'
                },
                colorful: {
                    '--primary-color': '#ff6b6b',
                    '--secondary-color': '#4ecdc4',
                    '--accent-color': '#ffe66d',
                    '--success-color': '#95e77e',
                    '--warning-color': '#ffa502',
                    '--bg-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    '--bg-secondary': '#ffffff',
                    '--radius-md': '20px',
                    '--shadow-lg': '0 20px 40px rgba(0, 0, 0, 0.2)'
                },
                corporate: {
                    '--primary-color': '#2c3e50',
                    '--secondary-color': '#34495e',
                    '--bg-primary': '#ecf0f1',
                    '--bg-secondary': '#ffffff',
                    '--text-primary': '#2c3e50',
                    '--font-primary': 'Arial, sans-serif',
                    '--radius-md': '4px'
                },
                playful: {
                    '--primary-color': '#ff00ff',
                    '--secondary-color': '#00ff00',
                    '--accent-color': '#ffff00',
                    '--bg-primary': '#fff8dc',
                    '--bg-secondary': '#ffffe0',
                    '--font-primary': "'Comic Sans MS', cursive",
                    '--radius-md': '25px',
                    '--shadow-lg': '0 10px 30px rgba(255, 0, 255, 0.3)'
                }
            };

            const preset = presets[presetName];
            if (preset) {
                Object.entries(preset).forEach(([property, value]) => {
                    document.documentElement.style.setProperty(property, value);
                    // Update corresponding input if exists
                    const inputId = property.replace('--', '').replace(/-/g, '-');
                    const input = document.getElementById(inputId);
                    if (input && input.type === 'color' && !value.includes('gradient')) {
                        input.value = value;
                    }
                });
                
                // Special handling for glass effect
                if (presetName === 'glass') {
                    document.getElementById('glass-toggle').checked = true;
                    document.querySelectorAll('.section, .header, .item-card').forEach(el => {
                        el.classList.add('glass');
                    });
                }
                
                saveStyles();
                showNotification(`Applied ${presetName} theme`, 'success');
            }
        }

        function toggleGlassEffect(enabled) {
            const elements = document.querySelectorAll('.section, .header, .item-card');
            elements.forEach(el => {
                if (enabled) {
                    el.classList.add('glass');
                } else {
                    el.classList.remove('glass');
                }
            });
            saveStyles();
        }

        function setBackgroundStyle(style) {
            const body = document.body;
            switch(style) {
                case 'gradient':
                    const primary = document.getElementById('bg-primary').value;
                    const secondary = document.getElementById('bg-secondary').value;
                    body.style.background = `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`;
                    break;
                case 'pattern':
                    body.style.background = `repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,.05) 10px, rgba(0,0,0,.05) 20px)`;
                    break;
                case 'solid':
                default:
                    body.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-primary');
            }
            saveStyles();
        }

        function toggleShadows(enabled) {
            if (!enabled) {
                updateCSS('--shadow-sm', 'none');
                updateCSS('--shadow-md', 'none');
                updateCSS('--shadow-lg', 'none');
                updateCSS('--shadow-xl', 'none');
            } else {
                updateCSS('--shadow-sm', '0 2px 4px rgba(0, 0, 0, 0.1)');
                updateCSS('--shadow-md', '0 4px 8px rgba(0, 0, 0, 0.15)');
                updateCSS('--shadow-lg', '0 8px 16px rgba(0, 0, 0, 0.2)');
                updateCSS('--shadow-xl', '0 12px 24px rgba(0, 0, 0, 0.25)');
            }
            saveStyles();
        }

        function updateShadowIntensity(value) {
            const opacity = value / 100;
            updateCSS('--shadow-sm', `0 2px 4px rgba(0, 0, 0, ${opacity * 0.1})`);
            updateCSS('--shadow-md', `0 4px 8px rgba(0, 0, 0, ${opacity * 0.15})`);
            updateCSS('--shadow-lg', `0 8px 16px rgba(0, 0, 0, ${opacity * 0.2})`);
            updateCSS('--shadow-xl', `0 12px 24px rgba(0, 0, 0, ${opacity * 0.25})`);
        }

        function toggleAnimations(enabled) {
            if (!enabled) {
                updateCSS('--transition-fast', '0ms');
                updateCSS('--transition-base', '0ms');
                updateCSS('--transition-slow', '0ms');
            } else {
                updateCSS('--transition-fast', '150ms');
                updateCSS('--transition-base', '250ms');
                updateCSS('--transition-slow', '500ms');
            }
            saveStyles();
        }

        function saveStyles() {
            const styles = {};
            const computedStyles = getComputedStyle(document.documentElement);
            
            // Get all CSS custom properties
            const allProperties = [
                '--primary-color', '--secondary-color', '--accent-color',
                '--success-color', '--warning-color', '--danger-color', '--info-color',
                '--bg-primary', '--bg-secondary', '--bg-tertiary',
                '--text-primary', '--text-secondary', '--text-light',
                '--border-color', '--border-light', '--border-dark',
                '--font-primary', '--font-size-base', '--font-weight-normal',
                '--line-height', '--letter-spacing',
                '--space-sm', '--space-md', '--space-lg',
                '--radius-sm', '--radius-md', '--radius-lg',
                '--shadow-sm', '--shadow-md', '--shadow-lg',
                '--transition-base', '--easing',
                '--glass-blur', '--glass-bg', '--glass-border'
            ];
            
            allProperties.forEach(prop => {
                const value = computedStyles.getPropertyValue(prop);
                if (value) {
                    styles[prop] = value.trim();
                }
            });
            
            // Save glass effect state
            styles.glassEffect = document.getElementById('glass-toggle')?.checked || false;
            
            localStorage.setItem('toolTrackerStyles', JSON.stringify(styles));
        }

        function loadStyles() {
            const saved = localStorage.getItem('toolTrackerStyles');
            if (saved) {
                const styles = JSON.parse(saved);
                Object.entries(styles).forEach(([property, value]) => {
                    if (property === 'glassEffect') {
                        if (value) {
                            document.getElementById('glass-toggle').checked = true;
                            toggleGlassEffect(true);
                        }
                    } else if (property.startsWith('--')) {
                        document.documentElement.style.setProperty(property, value);
                    }
                });
            }
        }

        function resetStyles() {
            if (confirm('Reset all styles to default?')) {
                localStorage.removeItem('toolTrackerStyles');
                location.reload();
            }
        }

        function exportStyles() {
            const styles = localStorage.getItem('toolTrackerStyles');
            const blob = new Blob([styles], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tool-tracker-styles.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Styles exported successfully', 'success');
        }

        function importStyles() {
            document.getElementById('import-file').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const styles = JSON.parse(e.target.result);
                        localStorage.setItem('toolTrackerStyles', JSON.stringify(styles));
                        loadStyles();
                        showNotification('Styles imported successfully', 'success');
                    } catch (error) {
                        showNotification('Invalid style file', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            
            // Load saved styles
            loadStyles();
            
            // Set initial status
            if (window.updateConnectionStatus) {
                window.updateConnectionStatus(false, 'Connecting...');
            }
            
            // Check GPS support
            checkGPSSupport();
            
            // Initialize item type dropdown
            initializeItemTypeDropdown();
            
            // Wait for Firebase initialization or use localStorage
            if (window.isFirebaseReady) {
                initializeAppData();
            } else {
                setTimeout(() => {
                    initializeAppData();
                }, 1000);
            }
            showLogin();
        });

        // Make this function available globally for Firebase initialization
        window.initializeAppData = function() {
            if (window.isFirebaseReady) {
                console.log('Using Firebase for data storage');
                document.getElementById('firebase-config-notice').style.display = 'none';
                if (window.updateConnectionStatus) {
                    window.updateConnectionStatus(true);
                }
                initializeFirebaseData();
            } else {
                console.log('Using localStorage for data storage');
                if (window.updateConnectionStatus) {
                    window.updateConnectionStatus(false, 'Local Storage');
                }
                initializeLocalData();
            }
        };

        // GPS Functions
        function testGPSOnLogin() {
            const resultDiv = document.getElementById('gps-test-result');
            const testBtn = document.querySelector('.gps-test-btn');
            
            testBtn.disabled = true;
            testBtn.textContent = 'Testing...';
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'gps-result';
            resultDiv.textContent = 'Checking GPS availability...';
            
            if (!navigator.geolocation) {
                resultDiv.className = 'gps-result error';
                resultDiv.textContent = '❌ GPS not supported on this device';
                testBtn.disabled = false;
                testBtn.textContent = 'Test GPS';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    resultDiv.className = 'gps-result success';
                    resultDiv.innerHTML = `✅ GPS working! Accuracy: ${Math.round(position.coords.accuracy)}m`;
                    updateGPSStatus('available');
                    testBtn.disabled = false;
                    testBtn.textContent = 'Test GPS';
                },
                function(error) {
                    resultDiv.className = 'gps-result error';
                    resultDiv.textContent = '❌ GPS unavailable or denied';
                    updateGPSStatus('unavailable');
                    testBtn.disabled = false;
                    testBtn.textContent = 'Test GPS';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function updateGPSStatus(status) {
            const dot = document.getElementById('gps-dot');
            const text = document.getElementById('gps-text');
            
            if (dot && text) {
                switch (status) {
                    case 'available':
                        dot.className = 'status-dot gps-available';
                        text.textContent = 'GPS Available';
                        break;
                    case 'unavailable':
                        dot.className = 'status-dot gps-unavailable';
                        text.textContent = 'GPS Unavailable';
                        break;
                    case 'loading':
                        dot.className = 'status-dot gps-loading';
                        text.textContent = 'Getting GPS...';
                        break;
                    default:
                        dot.className = 'status-dot gps-unknown';
                        text.textContent = 'GPS Unknown';
                }
            }
        }

        function checkGPSSupport() {
            if (!navigator.geolocation) {
                updateGPSStatus('unavailable');
                return;
            }

            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(permission) {
                    if (permission.state === 'granted') {
                        updateGPSStatus('available');
                    } else if (permission.state === 'denied') {
                        updateGPSStatus('unavailable');
                    } else {
                        updateGPSStatus('unknown');
                    }
                });
            }
        }

        // Initialize dropdown
        function initializeItemTypeDropdown() {
            const input = document.getElementById('new-item-type');
            const dropdown = document.getElementById('type-dropdown');
            
            if (!input || !dropdown) return;
            
            const savedTypes = JSON.parse(localStorage.getItem('itemTypes') || JSON.stringify(defaultItemTypes));
            
            input.addEventListener('focus', () => showTypeDropdown(savedTypes));
            input.addEventListener('input', () => filterTypeDropdown(savedTypes));
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.editable-dropdown')) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        function showTypeDropdown(types) {
            const dropdown = document.getElementById('type-dropdown');
            const input = document.getElementById('new-item-type');
            
            dropdown.innerHTML = '';
            
            types.forEach(type => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.textContent = type;
                option.onclick = () => selectType(type);
                dropdown.appendChild(option);
            });
            
            const inputValue = input.value.trim();
            if (inputValue && !types.includes(inputValue)) {
                const addOption = document.createElement('div');
                addOption.className = 'dropdown-option add-new';
                addOption.textContent = `+ Add "${inputValue}"`;
                addOption.onclick = () => addNewType(inputValue);
                dropdown.appendChild(addOption);
            }
            
            dropdown.classList.remove('hidden');
        }

        function filterTypeDropdown(types) {
            const input = document.getElementById('new-item-type');
            const query = input.value.toLowerCase();
            
            const filteredTypes = types.filter(type => 
                type.toLowerCase().includes(query)
            );
            
            showTypeDropdown(filteredTypes);
        }

        function selectType(type) {
            document.getElementById('new-item-type').value = type;
            document.getElementById('type-dropdown').classList.add('hidden');
        }

        function addNewType(newType) {
            const savedTypes = JSON.parse(localStorage.getItem('itemTypes') || JSON.stringify(defaultItemTypes));
            if (!savedTypes.includes(newType)) {
                savedTypes.push(newType);
                localStorage.setItem('itemTypes', JSON.stringify(savedTypes));
            }
            selectType(newType);
        }

        // Initialize Firebase data
        async function initializeFirebaseData() {
            try {
                const adminDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'settings', 'admin'));
                if (!adminDoc.exists()) {
                    await window.firestore.setDoc(window.firestore.doc(window.db, 'settings', 'admin'), {
                        pin: '999999',
                        createdAt: window.firestore.serverTimestamp()
                    });
                }

                const usersSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'users'));
                if (usersSnapshot.empty) {
                    const defaultUsers = [
                        { pin: '123456', name: 'John Smith' },
                        { pin: '234567', name: 'Jane Doe' },
                        { pin: '345678', name: 'Bob Johnson' }
                    ];

                    for (const user of defaultUsers) {
                        await window.firestore.setDoc(window.firestore.doc(window.db, 'users', user.pin), {
                            ...user,
                            createdAt: window.firestore.serverTimestamp()
                        });
                    }
                }

                console.log('Firebase data initialized');
            } catch (error) {
                console.error('Error initializing Firebase data:', error);
                showNotification('Firebase initialization failed. Using local storage.', 'error');
                if (window.updateConnectionStatus) {
                    window.updateConnectionStatus(false, 'Firebase Error');
                }
                initializeLocalData();
            }
        }

        // Initialize local data
        function initializeLocalData() {
            if (!localStorage.getItem('users')) {
                const defaultUsers = {
                    '123456': { name: 'John Smith', pin: '123456' },
                    '234567': { name: 'Jane Doe', pin: '234567' },
                    '345678': { name: 'Bob Johnson', pin: '345678' }
                };
                localStorage.setItem('users', JSON.stringify(defaultUsers));
            }

            if (!localStorage.getItem('adminPin')) {
                localStorage.setItem('adminPin', '999999');
            }

            if (!localStorage.getItem('items')) {
                localStorage.setItem('items', JSON.stringify({}));
            }

            if (!localStorage.getItem('activityLogs')) {
                localStorage.setItem('activityLogs', JSON.stringify([]));
            }

            if (!localStorage.getItem('itemStatus')) {
                localStorage.setItem('itemStatus', JSON.stringify({}));
            }

            if (!localStorage.getItem('itemTypes')) {
                localStorage.setItem('itemTypes', JSON.stringify(defaultItemTypes));
            }
        }

        // Data access functions
        async function getUsers() {
            if (window.isFirebaseReady) {
                try {
                    const snapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'users'));
                    const users = {};
                    snapshot.forEach(doc => {
                        users[doc.id] = doc.data();
                    });
                    return users;
                } catch (error) {
                    console.error('Error getting users from Firebase:', error);
                    return JSON.parse(localStorage.getItem('users') || '{}');
                }
            } else {
                return JSON.parse(localStorage.getItem('users') || '{}');
            }
        }

        async function saveUser(pin, userData) {
            if (window.isFirebaseReady) {
                try {
                    await window.firestore.setDoc(window.firestore.doc(window.db, 'users', pin), {
                        ...userData,
                        updatedAt: window.firestore.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving user to Firebase:', error);
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    users[pin] = userData;
                    localStorage.setItem('users', JSON.stringify(users));
                }
            } else {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                users[pin] = userData;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        async function deleteUser(pin) {
            if (window.isFirebaseReady) {
                try {
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'users', pin));
                } catch (error) {
                    console.error('Error deleting user from Firebase:', error);
                    const users = JSON.parse(localStorage.getItem('users') || '{}');
                    delete users[pin];
                    localStorage.setItem('users', JSON.stringify(users));
                }
            } else {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                delete users[pin];
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        async function getItems() {
            if (window.isFirebaseReady) {
                try {
                    const snapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'items'));
                    const items = {};
                    snapshot.forEach(doc => {
                        items[doc.id] = doc.data();
                    });
                    return items;
                } catch (error) {
                    console.error('Error getting items from Firebase:', error);
                    return JSON.parse(localStorage.getItem('items') || '{}');
                }
            } else {
                return JSON.parse(localStorage.getItem('items') || '{}');
            }
        }

        async function saveItem(itemId, itemData) {
            if (window.isFirebaseReady) {
                try {
                    await window.firestore.setDoc(window.firestore.doc(window.db, 'items', itemId), {
                        ...itemData,
                        updatedAt: window.firestore.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving item to Firebase:', error);
                    const items = JSON.parse(localStorage.getItem('items') || '{}');
                    items[itemId] = itemData;
                    localStorage.setItem('items', JSON.stringify(items));
                }
            } else {
                const items = JSON.parse(localStorage.getItem('items') || '{}');
                items[itemId] = itemData;
                localStorage.setItem('items', JSON.stringify(items));
            }
        }

        async function deleteItemData(itemId) {
            if (window.isFirebaseReady) {
                try {
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'items', itemId));
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, 'itemStatus', itemId));
                } catch (error) {
                    console.error('Error deleting item from Firebase:', error);
                    const items = JSON.parse(localStorage.getItem('items') || '{}');
                    const itemStatus = JSON.parse(localStorage.getItem('itemStatus') || '{}');
                    delete items[itemId];
                    delete itemStatus[itemId];
                    localStorage.setItem('items', JSON.stringify(items));
                    localStorage.setItem('itemStatus', JSON.stringify(itemStatus));
                }
            } else {
                const items = JSON.parse(localStorage.getItem('items') || '{}');
                const itemStatus = JSON.parse(localStorage.getItem('itemStatus') || '{}');
                delete items[itemId];
                delete itemStatus[itemId];
                localStorage.setItem('items', JSON.stringify(items));
                localStorage.setItem('itemStatus', JSON.stringify(itemStatus));
            }
        }

        async function getItemStatus() {
            if (window.isFirebaseReady) {
                try {
                    const snapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'itemStatus'));
                    const status = {};
                    snapshot.forEach(doc => {
                        status[doc.id] = doc.data();
                    });
                    return status;
                } catch (error) {
                    console.error('Error getting item status from Firebase:', error);
                    return JSON.parse(localStorage.getItem('itemStatus') || '{}');
                }
            } else {
                return JSON.parse(localStorage.getItem('itemStatus') || '{}');
            }
        }

        async function saveItemStatus(itemId, statusData) {
            if (window.isFirebaseReady) {
                try {
                    await window.firestore.setDoc(window.firestore.doc(window.db, 'itemStatus', itemId), {
                        ...statusData,
                        updatedAt: window.firestore.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving item status to Firebase:', error);
                    const itemStatus = JSON.parse(localStorage.getItem('itemStatus') || '{}');
                    itemStatus[itemId] = statusData;
                    localStorage.setItem('itemStatus', JSON.stringify(itemStatus));
                }
            } else {
                const itemStatus = JSON.parse(localStorage.getItem('itemStatus') || '{}');
                itemStatus[itemId] = statusData;
                localStorage.setItem('itemStatus', JSON.stringify(itemStatus));
            }
        }

        async function getActivityLogs() {
            if (window.isFirebaseReady) {
                try {
                    const snapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'activityLogs'));
                    const logs = [];
                    snapshot.forEach(doc => {
                        logs.push({ id: doc.id, ...doc.data() });
                    });
                    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    return logs;
                } catch (error) {
                    console.error('Error getting activity logs from Firebase:', error);
                    return JSON.parse(localStorage.getItem('activityLogs') || '[]');
                }
            } else {
                return JSON.parse(localStorage.getItem('activityLogs') || '[]');
            }
        }

        async function saveActivityLog(logData) {
            if (window.isFirebaseReady) {
                try {
                    const logId = Date.now().toString();
                    await window.firestore.setDoc(window.firestore.doc(window.db, 'activityLogs', logId), {
                        ...logData,
                        createdAt: window.firestore.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving activity log to Firebase:', error);
                    const logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
                    logs.unshift(logData);
                    if (logs.length > 100) logs.splice(100);
                    localStorage.setItem('activityLogs', JSON.stringify(logs));
                }
            } else {
                const logs = JSON.parse(localStorage.getItem('activityLogs') || '[]');
                logs.unshift(logData);
                if (logs.length > 100) logs.splice(100);
                localStorage.setItem('activityLogs', JSON.stringify(logs));
            }
        }

        async function clearActivityLogs() {
            if (window.isFirebaseReady) {
                try {
                    const snapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'activityLogs'));
                    const batch = [];
                    snapshot.forEach(doc => {
                        batch.push(window.firestore.deleteDoc(doc.ref));
                    });
                    await Promise.all(batch);
                } catch (error) {
                    console.error('Error clearing activity logs from Firebase:', error);
                    localStorage.setItem('activityLogs', JSON.stringify([]));
                }
            } else {
                localStorage.setItem('activityLogs', JSON.stringify([]));
            }
        }

        async function getAdminPin() {
            if (window.isFirebaseReady) {
                try {
                    const adminDoc = await window.firestore.getDoc(window.firestore.doc(window.db, 'settings', 'admin'));
                    return adminDoc.exists() ? adminDoc.data().pin : '999999';
                } catch (error) {
                    console.error('Error getting admin PIN from Firebase:', error);
                    return localStorage.getItem('adminPin') || '999999';
                }
            } else {
                return localStorage.getItem('adminPin') || '999999';
            }
        }

        function hideFirebaseNotice() {
            document.getElementById('firebase-config-notice').style.display = 'none';
        }

        // Navigation functions
        function showLogin() {
            hideAllSections();
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('user-info').textContent = 'Please sign in';
        }

        function showUserLogin() {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('user-login').classList.remove('hidden');
            document.getElementById('user-pin').focus();
        }

        function showAdminLogin() {
            document.getElementById('user-login').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('admin-pin').focus();
        }

        function hideAllSections() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('user-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('user-management').classList.add('hidden');
            document.getElementById('item-management').classList.add('hidden');
            document.getElementById('activity-logs').classList.add('hidden');
            document.getElementById('scanner-area').classList.add('hidden');
            document.getElementById('item-action').classList.add('hidden');
        }

        // Login functions
        async function loginUser() {
            const pin = document.getElementById('user-pin').value.trim();
            
            if (pin.length !== 6) {
                showNotification('Please enter a 6-digit PIN', 'error');
                return;
            }
            
            try {
                const users = await getUsers();
                
                if (users[pin]) {
                    currentUser = users[pin];
                    currentRole = 'user';
                    document.getElementById('user-info').textContent = `Welcome, ${currentUser.name}!`;
                    hideAllSections();
                    document.getElementById('user-section').classList.remove('hidden');
                    showNotification(`Welcome back, ${currentUser.name}!`, 'success');
                    console.log('User logged in:', currentUser.name);
                } else {
                    showNotification('Invalid PIN. Please try again.', 'error');
                    document.getElementById('user-pin').value = '';
                }
            } catch (error) {
                console.error('Error during login:', error);
                showNotification('Login failed. Please try again.', 'error');
            }
        }

        async function loginAdmin() {
            const pin = document.getElementById('admin-pin').value.trim();
            
            try {
                const adminPin = await getAdminPin();
                
                if (pin === adminPin) {
                    currentRole = 'admin';
                    currentUser = { name: 'Administrator' };
                    document.getElementById('user-info').textContent = 'Administrator Mode';
                    hideAllSections();
                    document.getElementById('admin-section').classList.remove('hidden');
                    showUserManagement();
                    showNotification('Admin login successful!', 'success');
                    console.log('Admin logged in');
                } else {
                    showNotification('Invalid admin PIN. Please try again.', 'error');
                    document.getElementById('admin-pin').value = '';
                }
            } catch (error) {
                console.error('Error during admin login:', error);
                showNotification('Admin login failed. Please try again.', 'error');
            }
        }

        function logout() {
            if (qrScanner) {
                stopScanner();
            }
            currentUser = null;
            currentRole = null;
            currentScannedItem = null;
            document.getElementById('user-pin').value = '';
            document.getElementById('admin-pin').value = '';
            showLogin();
            showNotification('Successfully signed out', 'info');
            console.log('User logged out');
        }

        // Admin functions
        function showUserManagement() {
            document.getElementById('item-management').classList.add('hidden');
            document.getElementById('activity-logs').classList.add('hidden');
            document.getElementById('user-management').classList.remove('hidden');
            displayUsers();
        }

        function showItemManagement() {
            document.getElementById('user-management').classList.add('hidden');
            document.getElementById('activity-logs').classList.add('hidden');
            document.getElementById('item-management').classList.remove('hidden');
            displayItems();
        }

        function showActivityLogs() {
            document.getElementById('user-management').classList.add('hidden');
            document.getElementById('item-management').classList.add('hidden');
            document.getElementById('activity-logs').classList.remove('hidden');
            displayActivityLogs();
        }

        async function addUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const pin = document.getElementById('new-user-pin').value.trim();
            
            if (!name) {
                showNotification('Please enter a user name.', 'error');
                return;
            }
            
            if (!pin || pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                showNotification('Please enter a valid 6-digit PIN (numbers only).', 'error');
                return;
            }
            
            try {
                const users = await getUsers();
                
                if (users[pin]) {
                    showNotification('PIN already exists. Please choose a different PIN.', 'error');
                    return;
                }
                
                await saveUser(pin, { name, pin });
                
                document.getElementById('new-user-name').value = '';
                document.getElementById('new-user-pin').value = '';
                
                displayUsers();
                showNotification(`User "${name}" added successfully!`, 'success');
                console.log('User added:', name, pin);
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Failed to add user. Please try again.', 'error');
            }
        }

        async function displayUsers() {
            try {
                const users = await getUsers();
                const usersList = document.getElementById('users-list');
                
                let html = '<h4>Current Users</h4><table><tr><th>Name</th><th>PIN</th><th>Actions</th></tr>';
                
                for (const [pin, user] of Object.entries(users)) {
                    html += `
                        <tr>
                            <td>${user.name}</td>
                            <td>${pin}</td>
                            <td><button onclick="deleteUserById('${pin}')" class="danger-btn">Delete</button></td>
                        </tr>
                    `;
                }
                
                html += '</table>';
                usersList.innerHTML = html;
            } catch (error) {
                console.error('Error displaying users:', error);
                document.getElementById('users-list').innerHTML = '<p>Error loading users.</p>';
            }
        }

        async function deleteUserById(pin) {
            try {
                const users = await getUsers();
                const userName = users[pin].name;
                
                if (confirm(`Are you sure you want to delete "${userName}"?`)) {
                    await deleteUser(pin);
                    displayUsers();
                    showNotification(`User "${userName}" deleted successfully!`, 'success');
                    console.log('User deleted:', pin);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Failed to delete user. Please try again.', 'error');
            }
        }

        async function addItem() {
            const name = document.getElementById('new-item-name').value.trim();
            const type = document.getElementById('new-item-type').value.trim();
            const brand = document.getElementById('new-item-brand').value.trim();
            const model = document.getElementById('new-item-model').value.trim();
            const serial = document.getElementById('new-item-serial').value.trim();
            const description = document.getElementById('new-item-description').value.trim();
            
            if (!name || !type || !brand || !model) {
                showNotification('Please fill in all required fields (marked with *).', 'error');
                return;
            }
            
            try {
                const itemId = 'ITEM' + Date.now().toString().slice(-6);
                
                const item = {
                    id: itemId,
                    name,
                    type,
                    brand,
                    model,
                    serial,
                    description,
                    dateAdded: new Date().toISOString()
                };
                
                await saveItem(itemId, item);
                
                await saveItemStatus(itemId, { 
                    status: 'available', 
                    checkedOutBy: null, 
                    checkedOutAt: null 
                });
                
                if (type) {
                    const savedTypes = JSON.parse(localStorage.getItem('itemTypes') || JSON.stringify(defaultItemTypes));
                    if (!savedTypes.includes(type)) {
                        savedTypes.push(type);
                        localStorage.setItem('itemTypes', JSON.stringify(savedTypes));
                    }
                }
                
                document.getElementById('new-item-name').value = '';
                document.getElementById('new-item-type').value = '';
                document.getElementById('new-item-brand').value = '';
                document.getElementById('new-item-model').value = '';
                document.getElementById('new-item-serial').value = '';
                document.getElementById('new-item-description').value = '';
                
                showNotification(`Item "${name}" added successfully!`, 'success');
                console.log('Item added:', itemId, name);
                
                displayItems();
            } catch (error) {
                console.error('Error adding item:', error);
                showNotification('Failed to add item. Please try again.', 'error');
            }
        }

        async function displayItems() {
            try {
                const items = await getItems();
                const itemStatus = await getItemStatus();
                const itemsList = document.getElementById('items-list');
                
                if (Object.keys(items).length === 0) {
                    itemsList.innerHTML = '<h4>No Items Yet</h4><p>Add your first item above to get started!</p>';
                    return;
                }
                
                let html = '<h4>Current Items</h4>';
                
                for (const [itemId, item] of Object.entries(items)) {
                    const status = itemStatus[itemId] || { status: 'available' };
                    const statusClass = status.status === 'available' ? 'status-available' : 'status-checked-out';
                    const statusText = status.status === 'available' ? 'Available' : `Checked out by ${status.checkedOutBy}`;
                    
                    html += `
                        <div class="item-card">
                            <h4>${item.name}</h4>
                            <p><strong>ID:</strong> ${itemId}</p>
                            <p><strong>Type:</strong> ${item.type}</p>
                            <p><strong>Brand:</strong> ${item.brand} - ${item.model}</p>
                            ${item.serial ? `<p><strong>Serial:</strong> ${item.serial}</p>` : ''}
                            ${item.description ? `<p><strong>Description:</strong> ${item.description}</p>` : ''}
                            <p><span class="item-status ${statusClass}">${statusText}</span></p>
                            
                            <div class="qr-container">
                                <p><strong>QR Code:</strong></p>
                                <canvas id="qr-${itemId}" class="qr-canvas" width="150" height="150"></canvas>
                                <p style="font-family: monospace; margin-top: 10px;">${itemId}</p>
                            </div>
                            
                            <button onclick="deleteItemById('${itemId}')" class="danger-btn">Delete Item</button>
                        </div>
                    `;
                }
                
                itemsList.innerHTML = html;
                
                setTimeout(() => {
                    for (const itemId of Object.keys(items)) {
                        generateQRCode(itemId);
                    }
                }, 100);
            } catch (error) {
                console.error('Error displaying items:', error);
                document.getElementById('items-list').innerHTML = '<p>Error loading items.</p>';
            }
        }

        function generateQRCode(itemId) {
            try {
                const canvas = document.getElementById(`qr-${itemId}`);
                if (!canvas) {
                    console.error('Canvas not found for item:', itemId);
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const qr = new QRious({
                    element: canvas,
                    value: itemId,
                    size: 150,
                    backgroundAlpha: 1,
                    background: '#ffffff',
                    foreground: '#000000',
                    level: 'M'
                });
                
                console.log('QR code generated for:', itemId);
            } catch (error) {
                console.error('Error generating QR code for', itemId, ':', error);
            }
        }

        async function deleteItemById(itemId) {
            try {
                const items = await getItems();
                const itemName = items[itemId].name;
                
                if (confirm(`Are you sure you want to delete "${itemName}"?`)) {
                    await deleteItemData(itemId);
                    displayItems();
                    showNotification(`Item "${itemName}" deleted successfully!`, 'success');
                    console.log('Item deleted:', itemId);
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('Failed to delete item. Please try again.', 'error');
            }
        }

        // Scanner functions
        function startScanning() {
            document.getElementById('scanner-area').classList.remove('hidden');
            document.getElementById('item-action').classList.add('hidden');
        }

        async function startScanner() {
            try {
                const video = document.getElementById('video');
                video.classList.remove('hidden');
                
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                qrScanner = new QrScanner(video, result => handleScanResult(result), {
                    returnDetailedScanResult: true,
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                });

                await qrScanner.start();
                scanning = true;
                
                document.getElementById('start-scanner-btn').classList.add('hidden');
                document.getElementById('stop-scanner-btn').classList.remove('hidden');
                document.getElementById('scanner-status').innerHTML = '<div class="status info">Scanning for QR codes...</div>';
                
                console.log('Scanner started');
                
            } catch (error) {
                console.error('Scanner error:', error);
                let errorMessage = 'Scanner failed to start. ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Please allow camera access and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'No camera found on this device.';
                } else {
                    errorMessage += 'Please check camera permissions.';
                }
                
                document.getElementById('scanner-status').innerHTML = `<div class="status error">${errorMessage}</div>`;
                showNotification(errorMessage, 'error');
            }
        }

        function stopScanner() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
                console.log('Scanner stopped');
            }
            
            scanning = false;
            document.getElementById('video').classList.add('hidden');
            document.getElementById('start-scanner-btn').classList.remove('hidden');
            document.getElementById('stop-scanner-btn').classList.add('hidden');
            document.getElementById('scanner-status').innerHTML = '<div class="status">Scanner stopped.</div>';
        }

        async function handleScanResult(result) {
            const scannedData = result.data.trim();
            console.log('QR code scanned:', scannedData);
            
            try {
                const items = await getItems();
                const item = items[scannedData];
                
                if (item) {
                    currentScannedItem = scannedData;
                    stopScanner();
                    showItemAction(scannedData, item);
                    showNotification(`Found item: ${item.name}`, 'success');
                } else {
                    document.getElementById('scanner-status').innerHTML = '<div class="status error">Unknown QR code.</div>';
                    showNotification('Unknown QR code. Item not in database.', 'error');
                }
            } catch (error) {
                console.error('Error handling scan result:', error);
                showNotification('Error processing QR code.', 'error');
            }
        }

        async function showItemAction(itemId, item) {
            try {
                const itemStatus = await getItemStatus();
                const status = itemStatus[itemId] || { status: 'available' };
                
                document.getElementById('scanner-area').classList.add('hidden');
                const actionDiv = document.getElementById('item-action');
                
                let html = `
                    <div class="item-card">
                        <h3>${item.name}</h3>
                        <p><strong>ID:</strong> ${itemId}</p>
                        <p><strong>Type:</strong> ${item.type}</p>
                        <p><strong>Brand:</strong> ${item.brand} - ${item.model}</p>
                        ${item.serial ? `<p><strong>Serial:</strong> ${item.serial}</p>` : ''}
                        ${item.description ? `<p><strong>Description:</strong> ${item.description}</p>` : ''}
                `;
                
                if (status.status === 'available') {
                    html += `
                        <p><span class="item-status status-available">Available for checkout</span></p>
                        <div class="action-buttons">
                            <button onclick="checkOutItem('${itemId}')">📤 Check Out This Item</button>
                            <button onclick="startScanning()" class="secondary-btn">Scan Another Item</button>
                        </div>
                    `;
                } else if (status.checkedOutBy === currentUser.name) {
                    html += `
                        <p><span class="item-status status-checked-out">Checked out by you</span></p>
                        <p><strong>Checked out:</strong> ${new Date(status.checkedOutAt).toLocaleString()}</p>
                        <div class="action-buttons">
                            <button onclick="checkInItem('${itemId}')">📥 Check In This Item</button>
                            <button onclick="startScanning()" class="secondary-btn">Scan Another Item</button>
                        </div>
                    `;
                } else {
                    html += `
                        <p><span class="item-status status-checked-out">Checked out by ${status.checkedOutBy}</span></p>
                        <p><strong>Checked out:</strong> ${new Date(status.checkedOutAt).toLocaleString()}</p>
                        <p style="color: var(--danger-color);">This item is currently unavailable.</p>
                        <div class="action-buttons">
                            <button onclick="startScanning()" class="secondary-btn">Scan Another Item</button>
                        </div>
                    `;
                }
                
                html += '</div>';
                actionDiv.innerHTML = html;
                actionDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error showing item action:', error);
                showNotification('Error loading item details.', 'error');
            }
        }

        async function checkOutItem(itemId) {
            if (!currentScannedItem || currentScannedItem !== itemId) {
                showNotification('Please scan the QR code first.', 'error');
                startScanning();
                return;
            }
            
            try {
                const items = await getItems();
                
                const statusData = {
                    status: 'checked-out',
                    checkedOutBy: currentUser.name,
                    checkedOutAt: new Date().toISOString()
                };
                
                await saveItemStatus(itemId, statusData);
                await logActivity('CHECK_OUT', itemId, items[itemId].name);
                
                showNotification(`${items[itemId].name} checked out successfully!`, 'success');
                showItemAction(itemId, items[itemId]);
                
                currentScannedItem = null;
                
            } catch (error) {
                console.error('Error checking out item:', error);
                showNotification('Failed to check out item.', 'error');
            }
        }

        async function checkInItem(itemId) {
            if (!currentScannedItem || currentScannedItem !== itemId) {
                showNotification('Please scan the QR code first.', 'error');
                startScanning();
                return;
            }
            
            try {
                const items = await getItems();
                
                const statusData = {
                    status: 'available',
                    checkedOutBy: null,
                    checkedOutAt: null
                };
                
                await saveItemStatus(itemId, statusData);
                await logActivity('CHECK_IN', itemId, items[itemId].name);
                
                showNotification(`${items[itemId].name} checked in successfully!`, 'success');
                showItemAction(itemId, items[itemId]);
                
                currentScannedItem = null;
                
            } catch (error) {
                console.error('Error checking in item:', error);
                showNotification('Failed to check in item.', 'error');
            }
        }

        async function logActivity(action, itemId, itemName) {
            try {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    action: action,
                    itemId: itemId,
                    itemName: itemName,
                    user: currentUser.name
                };
                
                await saveActivityLog(logEntry);
                console.log('Activity logged:', action, itemId, currentUser.name);
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        async function displayActivityLogs() {
            try {
                const logs = await getActivityLogs();
                const logsList = document.getElementById('logs-list');
                
                if (logs.length === 0) {
                    logsList.innerHTML = '<p>No activity logs yet.</p>';
                    return;
                }
                
                let html = '<h4>Recent Activity</h4><table><tr><th>Time</th><th>Action</th><th>Item</th><th>User</th></tr>';
                
                logs.forEach(log => {
                    const actionText = log.action === 'CHECK_OUT' ? '📤 Check Out' : '📥 Check In';
                    
                    html += `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${actionText}</td>
                            <td>${log.itemName}<br><small>${log.itemId}</small></td>
                            <td>${log.user}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
                logsList.innerHTML = html;
            } catch (error) {
                console.error('Error displaying activity logs:', error);
                document.getElementById('logs-list').innerHTML = '<p>Error loading activity logs.</p>';
            }
        }

        async function clearLogs() {
            if (confirm('Are you sure you want to clear all activity logs?')) {
                try {
                    await clearActivityLogs();
                    displayActivityLogs();
                    showNotification('Activity logs cleared!', 'success');
                } catch (error) {
                    console.error('Error clearing logs:', error);
                    showNotification('Failed to clear logs.', 'error');
                }
            }
        }

        function showNotification(message, type) {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            console.log(`Notification [${type}]:`, message);
        }

        // Handle Enter key for PIN inputs
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.id === 'user-pin') {
                    loginUser();
                } else if (e.target.id === 'admin-pin') {
                    loginAdmin();
                }
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
            }
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && qrScanner) {
                console.log('Page hidden, stopping scanner');
                stopScanner();
            }
        });

        // Make showNotification available globally
        window.showNotification = showNotification;
    </script>
</body>
</html>